<!DOCTYPE html>
<html>
	
	    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
    <meta content="Storm技术基础（一）" name="description">
  
  
    <meta name="keywords" content="Storm技术基础（一）,Storm,linux,kinglyjn,张庆力">
  
  <meta name="author" content="KinglyJn">

  <title>
    
        KinglyJn|Storm技术基础（一）
    
  </title>
  <!-- favicon -->
  <link rel="shortcut icon" href="static/img/favicon.ico">


  <!-- Third-party CSS -->
  <link href="/bower_components/normalize-css/normalize.min.css" rel="stylesheet">
  <link href="/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/bower_components/animate.css/animate.min.css" rel="stylesheet">
  <link href="/bower_components/components-font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="/static/font-mfizz/font-mfizz.css" rel="stylesheet">
  <!-- <link href="/bower_components/toastr/toastr.min.css" rel="stylesheet"> -->
  <link href="/bower_components/jquery.gritter/css/jquery.gritter.css" rel="stylesheet">
  <link rel="stylesheet" href="/search/css/cb-search.css">

  <!-- Custom styles for this template -->
  <link href="/static/css/style.min.css" rel="stylesheet">
  <link href="/static/css/pygments.css" rel="stylesheet">

  <!-- Scripts -->
  <script src="/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/search/js/bootstrap3-typeahead.min.js"></script>

  <!-- cb-search -->
  <script src="/search/js/cb-search.js"></script>
  <script>
    $(function(){
        $("pre").css('display','block');
    });
  </script>
  <!-- Mainly scripts -->
  <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="/bower_components/metisMenu/dist/metisMenu.min.js"></script>
  <script src="/bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>

  <!-- Peity -->
  <script src="/bower_components/peity/jquery.peity.min.js"></script>

  <script src="/bower_components/PACE/pace.min.js"></script>
  <script src="/bower_components/wow/dist/wow.min.js"></script>
  <!-- Custom and plugin javascript -->
  <script src="/static/js/inspinia.js"></script>

  <!-- Rickshaw -->
  <script src="/bower_components/rickshaw/vendor/d3.v3.js"></script>
  <script src="/bower_components/rickshaw/rickshaw.min.js"></script>


  <!-- jPages -->
  <script src="/static/js/jPages.js"></script>
  <script src="/static/js/js.js"></script>
  <script type="text/javascript">
        $(function(){
          /* initiate the plugin */
          $("div.pag-holder").jPages({
              containerID  : "pag-itemContainer",
              perPage      : 10,  /* num of items per page */
              startPage    : 1,
              startRange   : 1,
              midRange     : 3,
              endRange     : 1
          });

          $("div.pag-jump button").click(function(){
            var page = parseInt($("div.pag-jump input").val());
            $("div.pag-holder").jPages(page);
          });

          $("div.pag-jump input").on("keypress", function(){
            var e=e||window.event;
            if (e.keyCode == 13) {
                var page = parseInt($("div.pag-jump input").val());
                $("div.pag-holder").jPages(page);
            } 
          });
      });
  </script>

<!-- GrowingIO -->

  <script>
    var _vds = _vds || [];
    window._vds = _vds;
    (function(){
      _vds.push(['setAccountId', 'a49d4901c7853da9']);
      (function() {
        var vds = document.createElement('script');
        vds.type='text/javascript';
        vds.async = true;
        vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(vds, s);
      })();
    })();
  </script>


</head>

	


<body id="page-top" class="landing-page">

	
	    

<!--修复手机端横轴方向左右滑动BUG-->
<style type="text/css">
    .landing-page .row {
        margin-left: 0px;
        margin-right: 0px;
    }
</style>

<div class="search-tool"
      style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
    <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog">

    <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;">
        <img src="/search/img/cb-close.png" id="close-btn"/>
    </div>
</div>

<div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;">
    <img src="/search/img/cb-search.png"  id="search-btn"  title="Double click Ctrl"/>
</div>

<div class="navbar-wrapper">
        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header page-scroll">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">KinglyJn</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a class="page-scroll" href="/blog/"></a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/blog/">Blog</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/linux/">Linux</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/cloud/">Cloud</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/java/">Java</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/c/">C</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/py/">Py</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/php/">PHP</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/db/">DB</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/htmlx/">HTMLX</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/life/">Life</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/art/">Art</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/other/">Other</a></li>
                        
                    </ul>
                </div>
            </div>
        </nav>
</div>
<div id="inSlider" class="carousel carousel-fade" data-ride="carousel">
    <div style="position:absolute;float:left;left:25%;z-index:15;width:50%;margin-bottom:18%;bottom:0;text-align:center;list-style:none;">
        <span style="color:white;font-size:24px;">以平实之心写作</span><br>
        <span style="color:white;font-size:13px;">writing with simple heart ♬. </span>
    </div>
    <!--
    <ol class="carousel-indicators">
        <li data-target="#inSlider" data-slide-to="0" class="active"></li>
        <li data-target="#inSlider" data-slide-to="1"></li>
    </ol>
    -->
    <div class="carousel-inner" role="listbox">
        <div class="item active">
            <div class="container">
                <div class="carousel-caption">
                </div>
                <div class="carousel-image wow zoomIn">
                    <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> -->
                </div>
            </div>
            <!-- Set background for slide in css -->
            <div class="header-back blog-one"></div>
        </div>
        <!--
        <div class="item">
            <div class="container">
                <div class="carousel-caption blank">
                </div>
            </div>
            Set background for slide in css
            <div class="header-back two"></div>
        </div>
        -->
    </div>
    <!--
    <a class="left carousel-control" href="#inSlider" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
    </a>
    <a class="right carousel-control" href="#inSlider" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
    </a>
    -->
</div>


	

    <div class="wrapper wrapper-content  animated fadeInRight article">
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="ibox">
                <div class="ibox-content">
                    <div class="pull-right">
                    	
                        	<button class="btn btn-white btn-xs" type="button">Linux</button>
                        
                    </div>
                    <div class="text-center article-title" style="margin-bottom:50px;">
                        <h1>
                            Storm技术基础（一）
                        </h1>
                        <a href="http://www.keyllo.com/studio/">
                            <span class="text-muted"><i class="fa fa-user"></i> KinglyJn</span>
                        </a>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <span class="text-muted"><i class="fa fa-clock-o"></i> 2017-05-13</span>
                    </div>
                    	<h3 id="数据分析概述">数据分析概述</h3>

<pre><code class="language-default"># 数据分析一定是基于时段的

批处理：时段跨度相对很大（一般&gt;=1day, hadoop）
实时处理：时间跨度很小（一般&lt;=1s,GB or TB, storm[毫秒级别]、spark-streaming[秒级别]）
</code></pre>

<p><br /></p>

<h3 id="storm简介">storm简介</h3>

<pre><code class="language-default">底层：clojure，基于jvm的高级面向函数式的编程语言，
     阿里巴巴在storm的基础上使用java代替的了clojure的核心，并在性能上做了优化，产生了jstorm
     目前storm和jstorm都由apache管理

学习版本：0.9.6
</code></pre>

<p><br /></p>

<h3 id="下载安装配置">下载、安装、配置</h3>

<pre><code class="language-default"># 下载
http://www.apache.org/dyn/closer.lua/storm/apache-storm-0.9.6/apache-storm-0.9.6.tar.gz

# 前提
jdk1.7+
zookeeper集群（重启zk：bin/zkServer.sh restart）
python-2.6.6版以上胶水

# 解压修改配置文件
storm_env.ini 

storm.yaml
    sotrm.zookeeper.servers:
        zookeeper服务器列表
    storm.zookeeper.port:
        zookeeper服务连接端口
    storm.zookeeper.session.timeout:
        客户端连接zookeeper超时时间

    storm.local.dir:
        指定storm本地文件存放目录，存放任务jar以及少量的状态信息
    storm.cluster.mode:
        集群的运行模式（distributed|local）
    
    nimbus.host:
        nimbus服务器地址
        在storm1.0之后，该参数改为nimbus.seeds，用于配置主控节点的地址，可以配置多个
    nimbus.task.timeout.secs:
        判断task存活的心跳超时时间（storm支持多级别的task容错，而这个参数就是针对task界别容错的，
        storm判断task是否存活的心跳时间，超过了这个心跳时间，storm会进行故障转移，重新启动这个task）
    nimbus.task.launch.secs:
        task启动时的一个特殊超时设置，在拓扑任务任务启动后，第一次发送心跳前，
        将会使用这个值临时替代心跳，这是因为第一次启动时task需要较长的时间响应，
        所以这个值通常会大于task的正常心跳值
    nimbus.supervisor.timeout.secs:
        判断supervisor是否存活的心跳超时时间（storm针对supervisor容错的参数配置，
        storm判断supervisor是否存活的心跳时间，超过了这个时间，storm会认为这个
        supervisor失效了，进而进行相应的故障转移，将该节点上的任务全部转移到其他工作节点上）
    
    ui.port:
        指定storm-ui的web服务端口，默认是8080

    drpc.servers:
        分布式rpc的服务列表，以便DRPCSpout知道和谁进行通讯
    drpc.port:
        分布式rpc的服务端口

    supervisor.slots.ports
        指定supervisor节点启动一些工作进程时worker所使用的默认端口，若worker
        数大于这里配置的端口数，则其余的worker会使用其他端口作为自己的进程端口。
    supervisor.worker.timeout.secs:
        判断worker是否存活的心跳超时时间（storm针对worker容错的参数配置，
        storm检测心跳间隔超过了这个时间没得到响应，storm会进行worker重启）
    supervisor.worker.start.timeout.secs:
        类似于task的初始心跳（nimbus.task.launch.secs）


# 配置示例：
==========================================
storm.zookeeper.servers:
     - "nimbusz"
     - "supervisor01z" 
     - "supervisor02z" 

storm.local.dir: "/home/ubuntu/storm-local"
nimbus.seeds: ["nimbusz"]
ui.port: 8081

supervisor.slots.ports:
     - 6700
     - 6701
     - 6702

drpc.servers:
     - "nimbusz"
==========================================
</code></pre>

<p><br /></p>

<h3 id="storm安装部署架构">storm安装部署架构</h3>

<pre><code class="language-default">
    nimbus-----&gt;zk集群----&gt;【supervisor01进程---worker123进程---executor123线程】
                     ----&gt;【supervisor02】
                     ----&gt;【supervisor03】

# numbus主节点：
    1. 接收客户端提交的任务请求，任务由numbus进行分配（只是将分配信息提交到zk集群上，
       即在zk相应的znode节点上写入任务分配信息；supervisor查看这些znode上的任务
       分配信息，获取分配给它的任务）
    2. 监控整个集群的状态（从zk集群中相应的znode上读取supervisor和worker的状态信息）
    3. 容错（当任务在某些supervisor节点上运行的时候，由于supervisor进程失效，nimbus
       可以将这些任务重新分配给其他supervisor运行）

# supervisor从节点：
    1. 接收nimbus分配的任务，负责启动worker工作进程（其本身并不是执行任务工作的进程），
       worker的容错也由supervsior进程负责
    2. 需要将自己的运行状态信息（心跳信息）汇报给zk集群（写入到某个znode）
</code></pre>

<p><br /></p>

<h4 id="启动nimbus进程">启动nimbus进程</h4>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># 需要在配置文件中nimbus.host参数指定的服务器上启动</span>

阻塞启动：bin/storm nimbus
后台启动：nohup bin/storm nimbus &gt;&gt; /dev/null 2&gt;&amp;1 &amp;

jps查看java进程：
    config_value 表示正在启动读取配置文件中
    numbus 表示numbus启动完成进程

ps查看进程
    ps -ef |grep daemon.nimbus
</code></pre>
</div>

<p><br /></p>

<h4 id="启动ui进程需要在nimbus节点上启动">启动ui进程（需要在nimbus节点上启动）</h4>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>nohup bin/storm ui &gt;&gt; /dev/null 2&gt;&amp;1 &amp;

jps查看java进程：
    config_value 表示正在启动读取配置文件中
    core 表示ui启动完成进程

ps查看进程
    ps -ef |grep daemon.ui.core

netstat查看通信端口
    netstat -lntpu | grep 8081（或其他你指定端口）
</code></pre>
</div>

<p><br /></p>

<h4 id="启动supervisor进程">启动supervisor进程</h4>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>nohup bin/storm supervisor &gt;&gt; /dev/null 2&gt;&amp;1 &amp;

jps查看java进程：    
    config_value 表示正在启动读取配置文件中
    supervisor 表示supervisor启动完成进程

ps查看进程：
    ps -ef |grep daemon.supervisor
</code></pre>
</div>

<p><br /></p>

<h4 id="启动logviewer进程">启动logviewer进程</h4>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># logviewer进程负责收集每个supervisor节点的日志（需要在每个supervisor节点上启动）</span>
nohup bin/storm logviewer &gt;&gt; /dev/null 2&gt;&amp;1 &amp;

jps查看java进程：    
    config_value 表示正在启动读取配置文件中
    logviewer 表示logviewer启动完成进程

ps查看进程：
    ps -ef |grep daemon.logviewer
</code></pre>
</div>

<p><br /></p>

<h4 id="worker进程和executor线程">worker进程和executor线程</h4>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># worker进程负责启动executor线程去真正执行客户端提交到storm集群上的</span>
<span class="c"># 任务（task：包含spout和bolt），但它并不是常驻进程，不能通过手动启动。</span>
<span class="c"># worker进程启动以后，也会定期将自己的状态信息汇报给zk集群</span>
</code></pre>
</div>

<p><br /></p>

<h4 id="nimbus提交和执行拓扑任务">nimbus提交和执行拓扑任务</h4>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># 拓扑任务架构[本质是一个DAG，即有向无环图]</span>

<span class="gp">数据来源（如kafka）---&gt; </span>数据喷头[spout]----tuple----&gt; bolt12345...

<span class="c"># 使用官方提供的案例进行拓扑任务的提交</span>
bin/storm jar examples/storm-starter/storm-starter-topologies-0.9.4.jar storm.starter.WordCountTopology wordcount

examples/storm-starter/storm-starter-topologies-0.9.4.jar：表示拓扑任务jar包
storm.starter.WordCountTopology：表示拓扑任务主类
wordcount：表示随意指定的拓扑任务名称


<span class="c"># 启动日志</span>
...
361  <span class="o">[</span>main] INFO  backtype.storm.StormSubmitter - Jar not uploaded to master yet. Submitting jar...
370  <span class="o">[</span>main] INFO  backtype.storm.StormSubmitter - Uploading topology jar apache-storm-0.9.4/examples/storm-starter/storm-starter-topologies-0.9.4.jar to assigned location: /home/ubuntu/storm-local/nimbus/inbox/stormjar-e8fb8969-5476-446e-9f3a-20ce4b73dc89.jar
Start uploading file <span class="s1">'apache-storm-0.9.4/examples/storm-starter/storm-starter-topologies-0.9.4.jar'</span> to <span class="s1">'/home/ubuntu/storm-local/nimbus/inbox/stormjar-e8fb8969-5476-446e-9f3a-20ce4b73dc89.jar'</span> <span class="o">(</span>3248682 bytes<span class="o">)</span>
<span class="o">[==================================================]</span> 3248682 / 3248682
File <span class="s1">'apache-storm-0.9.4/examples/storm-starter/storm-starter-topologies-0.9.4.jar'</span> uploaded to <span class="s1">'/home/ubuntu/storm-local/nimbus/inbox/stormjar-e8fb8969-5476-446e-9f3a-20ce4b73dc89.jar'</span> <span class="o">(</span>3248682 bytes<span class="o">)</span>
452  <span class="o">[</span>main] INFO  backtype.storm.StormSubmitter - Successfully uploaded topology jar to assigned location: /home/ubuntu/storm-local/nimbus/inbox/stormjar-e8fb8969-5476-446e-9f3a-20ce4b73dc89.jar
452  <span class="o">[</span>main] INFO  backtype.storm.StormSubmitter - Submitting topology wordcount <span class="k">in </span>distributed mode with conf <span class="o">{</span><span class="s2">"topology.workers"</span>:3,<span class="s2">"topology.debug"</span>:true<span class="o">}</span>
697  <span class="o">[</span>main] INFO  backtype.storm.StormSubmitter - Finished submitting topology: wordcount
</code></pre>
</div>

<p><br /></p>

<h4 id="停止拓扑任务的执行">停止拓扑任务的执行</h4>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># 拓扑任务提交到storm集群上运行后，除非手动执行kill命令，否则将一直永远运行下去</span>
<span class="c"># 而相比之下，mapreduce任务把数据处理完就终止了</span>

<span class="c"># 其中wordcount是你指定的拓扑任务名称</span>
bin/storm <span class="nb">kill </span>wordcount


<span class="c"># 停止日志</span>
...
671  <span class="o">[</span>main] INFO  backtype.storm.thrift - Connecting to Nimbus at nimbusz:6627
709  <span class="o">[</span>main] INFO  backtype.storm.command.kill-topology - Killed topology: wordcount
</code></pre>
</div>

<p><br /></p>

<h3 id="storm常用命令">storm常用命令</h3>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>active          激活指定的任务
classpath       打印storm的classpath
dev-zookeeper   启动一个新的zookeeper，这种情况只用于开发或测试
drpc            启动一个drpc进程
jar             运行自己的拓扑任务
<span class="nb">kill            </span>通过任务名kill掉一个任务（storm使用杀进程方法关闭任务，cleanup不能执行）
deactivate      暂停storm的任务
rebalance       节点扩展之后进行负载均衡
list            列出正在运行的topolofies和状态
localconfvalue  打印出具体配置参数在本地storm配置文件中的值
remoteconfvalue 打印出具体配置参数在storm集群中的值
nimbus          启动一个nimbus进程
supervisor      启动一个supervisor进程
ui              启动ui监控页面ui的后台进程
<span class="nb">help            </span>命令解释及操作提示
</code></pre>
</div>

<p><br /></p>

<h4 id="在zk中查看nimbus和supervisor提交的信息">在zk中查看nimbus和supervisor提交的信息</h4>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 1] ls /
<span class="o">[</span>storm, zookeeper]

<span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 2] ls /storm
<span class="o">[</span>workerbeats, errors, supervisors, storms, assignments]

<span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 3] ls /storm/workerbeats
<span class="o">[</span>wordcount-2-1496654788]
<span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 5] ls /storm/workerbeats/wordcount-2-1496654788
<span class="o">[</span>83b7f23f-ad0b-45bd-85b8-500fd475fac3-6700, c3b030e5-a37a-485a-b96c-dc566a43fe9e-6700]

<span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 4] ls /storm/errors     
<span class="o">[</span>wordcount-2-1496654788]
<span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 2] ls /storm/errors/wordcount-2-1496654788
<span class="o">[</span>split, count, __acker, spout]

<span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 3] ls /storm/supervisors
<span class="o">[</span>c3b030e5-a37a-485a-b96c-dc566a43fe9e, 83b7f23f-ad0b-45bd-85b8-500fd475fac3]

<span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 6] ls /storm/storms                                          
<span class="o">[</span>wordcount-2-1496654788]

<span class="o">[</span>zk: localhost:2181<span class="o">(</span>CONNECTED<span class="o">)</span> 9] ls /storm/assignments
<span class="o">[</span>wordcount-2-1496654788]


<span class="c"># workerbeats：表示worker工作进程的工作状态信息</span>
<span class="c"># errors：表示topology正在运行过程中出现异常的task信息，</span>
         <span class="c">#方便nimbus重新将运行出错的任务进行重新分配</span>
<span class="c"># supervisors：表示supervisor节点的状态信息</span>
<span class="c"># storms：表示topology的基本配置信息</span>
<span class="c"># assignments：表示任务的分配信息，nimbus节点接收到客户端提交的拓扑任务后会</span>
              <span class="c">#对任务进行分配（将分配信息存储到znode中）；supervisor节点</span>
              <span class="c">#读取znode中的assignments信息，拿到分配给自己的任务，然后</span>
              <span class="c">#supervisor启动worker进程执行具体的任务，worker进程将使用</span>
              <span class="c">#多个executor线程进行工作</span>
</code></pre>
</div>

<p><br /></p>

<h3 id="拓扑任务的分组策略">拓扑任务的分组策略</h3>

<ul>
  <li>shuffleGrouping（随机分组）</li>
  <li>fieldsGrouping（按照字段分组，在这里即是同一个单词只能发送给一个Bolt）</li>
  <li>allGrouping（广播发送，即每一个Tuple，每一个Bolt都会收到）</li>
  <li>globalGrouping（全局分组，将Tuple分配到task id值最低的task里面）</li>
  <li>noneGrouping（随机分派）</li>
  <li>directGrouping（直接分组，指定Tuple与Bolt的对应发送关系）</li>
  <li>Local or shuffle Grouping</li>
  <li>customGrouping （自定义的Grouping）</li>
</ul>

<p><br /></p>

<h3 id="storm的编程模型javaapi构建拓扑任务以wordcount任务为例">storm的编程模型，javaAPI构建拓扑任务（以wordcount任务为例）</h3>

<blockquote>
  <p>注意：所有类最好实现序列化接口，最好发射string类型数据</p>

  <p>技术选型使用storm，依靠storm的实时性以及大规模数据的特点。在spout中是随机发送内置语句作为数据源；使用一个bolt进行语句切分，将句子切分成单词发射出去；使用一个bolt订阅切分的单词tuple，进行单词统计，并且选用安字段分组的策略，词频实时排序，把topN实时发射出去；使用一个bolt将结果打印到log中；拓扑结构为 RandomSentenceSpout—-&gt;WordNormalizerBold—-&gt;WordCountBolt—-&gt;PrintBolt</p>
</blockquote>

<p><br /></p>

<p><strong>拓扑任务驱动类</strong></p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">wordcount</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.storm.Config</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.LocalCluster</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.StormSubmitter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.TopologyBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Fields</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.utils.Utils</span><span class="o">;</span>

<span class="cm">/**
 * 驱动类（构造拓扑）
 * @author zhangqingli
 *
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WordcountTopology</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">TopologyBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopologyBuilder</span><span class="o">();</span>
		
		<span class="c1">//线程数为2</span>
		<span class="n">builder</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="s">"randomSentenceSpout"</span><span class="o">,</span> <span class="k">new</span> <span class="n">RandomSentenceSpout</span><span class="o">(),</span> <span class="mi">2</span><span class="o">);</span> 
		<span class="c1">//线程数为2，使用随机分组，订阅的消息为randomSentenceSpout</span>
		<span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"wordNomalizerBolt"</span><span class="o">,</span> <span class="k">new</span> <span class="n">WordNomalizerBolt</span><span class="o">(),</span> <span class="mi">2</span><span class="o">).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"randomSentenceSpout"</span><span class="o">);</span> 
		<span class="c1">//线程数为2，使用按字段分组，订阅的消息为wordNomalizerBolt</span>
		<span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"wordCountBolt"</span><span class="o">,</span> <span class="k">new</span> <span class="n">WordCountBolt</span><span class="o">(),</span> <span class="mi">2</span><span class="o">).</span><span class="na">fieldsGrouping</span><span class="o">(</span><span class="s">"wordNomalizerBolt"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"word"</span><span class="o">));</span> 
		<span class="c1">//线程数为1，使用全局分组（慎用，数据量可能很大），订阅的消息为wordCountBolt</span>
		<span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"printBolt"</span><span class="o">,</span> <span class="k">new</span> <span class="n">PrintBolt</span><span class="o">(),</span> <span class="mi">1</span><span class="o">).</span><span class="na">globalGrouping</span><span class="o">(</span><span class="s">"wordCountBolt"</span><span class="o">);</span>
		<span class="c1">//设置一些参数</span>
		<span class="n">Config</span> <span class="n">stormConf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Config</span><span class="o">();</span> <span class="c1">//在spout或bolt中可以通过conf map入参获取</span>
		<span class="n">stormConf</span><span class="o">.</span><span class="na">setDebug</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
		<span class="n">stormConf</span><span class="o">.</span><span class="na">setNumAckers</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		
		<span class="c1">//通过是否有参数来控制是否启动集群（或本地方式运行）</span>
		<span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">//最好一台机器上的一个topology只使用一个worker,主要原因时减少了worker之间的数据传输</span>
			<span class="n">stormConf</span><span class="o">.</span><span class="na">setNumWorkers</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">StormSubmitter</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">stormConf</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">createTopology</span><span class="o">());</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">stormConf</span><span class="o">.</span><span class="na">setMaxTaskParallelism</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
			<span class="n">LocalCluster</span> <span class="n">localCluster</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalCluster</span><span class="o">();</span>
			<span class="n">localCluster</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="s">"wordcount"</span><span class="o">,</span> <span class="n">stormConf</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">createTopology</span><span class="o">());</span>
			
			<span class="c1">//本地集群需要手动关闭</span>
			<span class="n">Utils</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">60000</span><span class="o">);</span>
			<span class="n">localCluster</span><span class="o">.</span><span class="na">killTopology</span><span class="o">(</span><span class="s">"wordcount"</span><span class="o">);</span>
			<span class="n">localCluster</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><br /></p>

<p><strong>spout组件</strong></p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">wordcount</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.spout.SpoutOutputCollector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.task.TopologyContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.IRichSpout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.OutputFieldsDeclarer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Fields</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Values</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.utils.Utils</span><span class="o">;</span>

<span class="cm">/**
 * Spout组件（继承BaseRichSpout 或 实现IRichSpout）
 * @author zhangqingli
 *
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RandomSentenceSpout</span> <span class="kd">implements</span> <span class="n">IRichSpout</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
	
	<span class="kd">private</span> <span class="n">SpoutOutputCollector</span> <span class="n">spoutOutputCollector</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Values</span><span class="o">&gt;</span> <span class="n">tupleMap</span><span class="o">;</span> <span class="c1">//tuple缓存器</span>

	<span class="cm">/**
	 * 初始化方法
	 * 首先被调用，且只被调用一次，一般用于初始化变量，如SpoutOutputCollector发射器
	 */</span>
	<span class="nd">@Override</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="n">Map</span> <span class="n">conf</span><span class="o">,</span> <span class="n">TopologyContext</span> <span class="n">context</span><span class="o">,</span> <span class="n">SpoutOutputCollector</span> <span class="n">collector</span><span class="o">)</span> <span class="o">{</span> 		  <span class="c1">//conf表示驱动类中的stormConf</span>
		<span class="n">spoutOutputCollector</span> <span class="o">=</span> <span class="n">collector</span><span class="o">;</span>
		<span class="n">tupleMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
	<span class="o">}</span>
	
	<span class="cm">/**
	 * 收尾方法
	 * 一般用于释放资源
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
		 
	<span class="o">}</span>
	
	<span class="cm">/**
	 * 激活方法
	 * 当拓扑任务被暂停重新激活时会调用该方法，一般该方法默认即可
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="o">()</span> <span class="o">{</span>
		
	<span class="o">}</span>
	
	<span class="cm">/**
	 * 暂停方法
	 * 当拓扑任务被暂停时会调用该方法，一般该方法默认即可
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deactivate</span><span class="o">()</span> <span class="o">{</span>
		
	<span class="o">}</span>
	
	<span class="cm">/**
	 * 核心方法
	 * 会被循环调用，实现如何从数据源上获取数据和向后面的组件bolt发射数据的逻辑
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">nextTuple</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Utils</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
		<span class="n">String</span><span class="o">[]</span> <span class="n">sentences</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span>
				<span class="s">"Implement a parser wrapper by extending"</span><span class="o">,</span>
				<span class="s">"the FeedNormalizer Parser class and"</span><span class="o">,</span>
				<span class="s">"overriding the public methods. Also note"</span><span class="o">,</span> 
				<span class="s">"the helper methods in the root Parser"</span><span class="o">,</span>
				<span class="s">"object to make mapping of output from"</span><span class="o">,</span> 
				<span class="s">"the particular parser to the Feed object easier."</span>
		<span class="o">};</span>
		<span class="n">String</span> <span class="n">sentence</span> <span class="o">=</span> <span class="n">sentences</span><span class="o">[</span><span class="k">new</span> <span class="nf">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">sentences</span><span class="o">.</span><span class="na">length</span><span class="o">)];</span>
		
		<span class="n">String</span> <span class="n">msgId</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span> <span class="c1">//msgId（消息保障机制用）</span>
		<span class="n">Values</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="n">sentence</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">());</span> <span class="c1">//tuple</span>
		<span class="n">tupleMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">msgId</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span> <span class="c1">//将tuple添加到自定义缓存中</span>
		<span class="n">spoutOutputCollector</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="n">values</span><span class="o">,</span> <span class="n">msgId</span><span class="o">);</span> <span class="c1">//发射</span>
		
		<span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">"，发射的语句："</span> <span class="o">+</span> <span class="n">sentence</span><span class="o">);</span>
		<span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">"，tupleMap缓存："</span> <span class="o">+</span> <span class="n">tupleMap</span><span class="o">);</span>
	<span class="o">}</span>
	
	
	<span class="cm">/**
	 * 消息可靠性保障ack方法
	 * 当拓扑任务启用了消息可靠性保障机制，当某个tuple在拓扑任务上处理成功后，调用ack方法执行一些处理逻辑
	 * 
	 * 启用消息的确认机制步骤：
	 * 在第一个spout或bolt中：
	 * 		1. 发射器发射tuple时需要指定一个msgId
	 * 		2. 使用map缓存所发射的tuple（key为msgId，value为emit_values）
	 * 		3. 在ack方法中（此时已经能够确认消息发射成功）将缓存从map中移除
	 * 		4. 在fail方法中（此时已经能够确认消息发射失败）进行重试或其他补救操作
	 * 在下一个spout或bolt中：（如果需要继续往后面组件发射消息）
	 * 		1. 需要锚定前面的tuple【collector.emit(inputTuple, new Values("xxx"))】
	 * 		2. 消息处理成功调用收集器的ack方法【collector.ack(inputTuple)】
	 * 		3. 消息处理过程有异常调用收集器的fail方法【collector.fail(inputTuple)】
	 * 
	 * 对性能的影响：
	 * 		如果启用了消息保障性机制，一定会对拓扑任务的执行的效率产生影响，如果性能影响超过可接受范围，
	 * 		解决方法是增加acker组件的并发度（增加执行acker任务的executor线程个数），即可以通过设置
	 * 		stormConf.setNumAckers(5)来做。
	 * 
	 * 关于锚定：
	 * 所谓的锚定(anchoring)是指为 tupleTree 中增加一个新的节点。在bolt中你可以通过 
	 * collector.emit(tuple,new Values(xx)) 将该tuple发送到下个bolt，此时new Value 
	 * 就被锚定在该 tuple 上了。你可以认为 tuple tree 之间link的建立称为锚定。
	 * 
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ack</span><span class="o">(</span><span class="n">Object</span> <span class="n">msgId</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">"，消息发射成功msgId："</span> <span class="o">+</span> <span class="n">msgId</span><span class="o">);</span>
		<span class="c1">//确认发射成功，将tuple从缓存中移除</span>
		<span class="n">tupleMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">msgId</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 消息可靠性保障fail方法
	 * 当拓扑任务启用了消息可靠性保障机制，当某个tuple在拓扑任务上处理失败或超时后，
	 * 调用fail方法执行一些处理逻辑
	 * 
	 * 关于成功与失败：
	 * 在Storm的一个Topology中，Spout通过 SpoutOutputCollector 的emit()方法
	 * 发射一个tuple(源)即消息。而后经过在该Topology中定义的多个Bolt处理时，可能
	 * 会产生一个或多个新的Tuple。源Tuple和新产生的Tuple便构成了一个Tuple树。当整
	 * 棵树被处理完成，才算一个Tuple被完全处理，其中任何一个节点的Tuple处理失败或超
	 * 时，则整棵树失败。关于消息在storm中的超时默认为30秒，具体参看 defaults.yaml 
	 * 中的 topology.message.timeout.secs: 30 的配置。同时，你也可以在定义
	 * topology时，通过conf.setMessageTimeoutSecs方法指定超时时间。storm所谓的
	 * 消息可靠性指的是storm保证每个tuple都能被toplology完全处理。而且处理的结果要
	 * 么成功要么失败。出现失败的原因可能有两种即节点处理失败或者处理超时。
	 * 
	 * 有三种方法可以去掉可靠性:
	 * 1. 第一是把Config.TOPOLOGY_ACKERS 设置成 0. 在这种情况下，storm会在spout
	 *    发射一个tuple之后马上调用spout的ack方法。也就是说这个tuple树不会被跟踪。
	 * 2. 第二个方法是在tuple层面去掉可靠性。 你可以在发射tuple的时候不指定messageid
	 *    来达到不跟粽某个特定的spout tuple的目的。
	 * 3. 最后一个方法是如果你对于一个tuple树里面的某一部分到底成不成功不是很关心，那么
	 *    可以在发射这些tuple的时候unanchor它们。这样这些tuple就不在tuple树里面，也
	 *    就不会被跟踪了。
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">fail</span><span class="o">(</span><span class="n">Object</span> <span class="n">msgId</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">"，消息发射失败msgId："</span> <span class="o">+</span> <span class="n">msgId</span><span class="o">);</span>
		<span class="c1">//消息发射失败，重试</span>
		<span class="n">Values</span> <span class="n">values</span> <span class="o">=</span> <span class="n">tupleMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">msgId</span><span class="o">);</span>
		<span class="n">spoutOutputCollector</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="n">values</span><span class="o">,</span> <span class="n">msgId</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 声明向后面发射的tuple的key
	 * 
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="n">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">declarer</span><span class="o">.</span><span class="na">declare</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"sentence"</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 设置spout组件专用的参数
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getComponentConfiguration</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><br /></p>

<p><strong>bolt1组件（负责获取spout组件发送的消息，并将消息切分成单词向后发射）</strong></p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">wordcount</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.task.OutputCollector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.task.TopologyContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.IRichBolt</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.OutputFieldsDeclarer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Fields</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Tuple</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Values</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WordNomalizerBolt</span> <span class="kd">implements</span> <span class="n">IRichBolt</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

	<span class="kd">private</span> <span class="n">OutputCollector</span> <span class="n">outputCollector</span><span class="o">;</span>
	
	<span class="cm">/**
	 * worker启动时初始化方法
	 * 功能类似于spout的open
	 */</span>
	<span class="nd">@Override</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">(</span><span class="n">Map</span> <span class="n">paramMap</span><span class="o">,</span> <span class="n">TopologyContext</span> <span class="n">paramTopologyContext</span><span class="o">,</span>
			<span class="n">OutputCollector</span> <span class="n">paramOutputCollector</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">outputCollector</span> <span class="o">=</span> <span class="n">paramOutputCollector</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 接收一个tuple并执行逻辑处理，发射出去
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Tuple</span> <span class="n">paramTuple</span><span class="o">)</span> <span class="o">{</span>
		
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">String</span> <span class="n">sentence</span> <span class="o">=</span> <span class="n">paramTuple</span><span class="o">.</span><span class="na">getStringByField</span><span class="o">(</span><span class="s">"sentence"</span><span class="o">);</span>
			<span class="n">String</span><span class="o">[]</span> <span class="n">words</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
			
			<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">word</span> <span class="o">:</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">//outputCollector.emit(new Values(word));</span>
                <span class="c1">//启用消息保障机制，需要锚定接收到的tuple</span>
				<span class="n">outputCollector</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="n">paramTuple</span><span class="o">,</span> <span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="n">word</span><span class="o">));</span> 
			<span class="o">}</span>
			
			<span class="c1">//确认消息处理成功</span>
			<span class="n">outputCollector</span><span class="o">.</span><span class="na">ack</span><span class="o">(</span><span class="n">paramTuple</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="c1">//确认消息处理失败</span>
			<span class="n">outputCollector</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">paramTuple</span><span class="o">);</span> 
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 收尾方法（不保证一定被调用，因为我们停止拓扑任务的时候一般是采取杀进程的方法）
	 * 一般用于释放资源
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">cleanup</span><span class="o">()</span> <span class="o">{</span>
		
	<span class="o">}</span>

	<span class="cm">/**
	 * 声明向后面发射的tuple的key
	 * 
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span>
			<span class="n">OutputFieldsDeclarer</span> <span class="n">paramOutputFieldsDeclarer</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">paramOutputFieldsDeclarer</span><span class="o">.</span><span class="na">declare</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"word"</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 设置spout组件专用的参数
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getComponentConfiguration</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><br /></p>

<p><strong>bolt2组件（负责统计出前10个单词，并把统计结果向后发射）</strong></p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">wordcount</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Comparator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedHashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map.Entry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.task.OutputCollector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.task.TopologyContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.IRichBolt</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.OutputFieldsDeclarer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Fields</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Tuple</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Values</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WordCountBolt</span> <span class="kd">implements</span> <span class="n">IRichBolt</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">OutputCollector</span> <span class="n">outputCollector</span><span class="o">;</span>
	<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">counterMap</span><span class="o">;</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">cleanup</span><span class="o">()</span> <span class="o">{</span>
		
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Tuple</span> <span class="n">inputTuple</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">inputTuple</span><span class="o">.</span><span class="na">getStringByField</span><span class="o">(</span><span class="s">"word"</span><span class="o">);</span>
		
		<span class="k">if</span> <span class="o">(!</span><span class="n">counterMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">str</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">counterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">Integer</span> <span class="n">c</span> <span class="o">=</span> <span class="n">counterMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">str</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
			<span class="n">counterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
		<span class="o">}</span>
		
		<span class="c1">//只取词频最大的前十个</span>
		<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		
		<span class="c1">//对map进行排序</span>
		<span class="n">counterMap</span> <span class="o">=</span> <span class="n">sortByMap</span><span class="o">(</span><span class="n">counterMap</span><span class="o">);</span>
		
		<span class="k">if</span> <span class="o">(</span><span class="n">counterMap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">counterMap</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
		<span class="o">}</span>
		
		<span class="c1">//增量统计</span>
		<span class="n">String</span> <span class="n">countResult</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">counterMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">countResult</span> <span class="o">=</span> <span class="s">"["</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">counterMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">+</span><span class="s">"]"</span><span class="o">;</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">countResult</span> <span class="o">=</span> <span class="n">countResult</span> <span class="o">+</span> <span class="s">", ["</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">counterMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">+</span><span class="s">"]"</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">count</span><span class="o">++;</span>
		<span class="o">}</span>
		
		<span class="n">countResult</span> <span class="o">=</span> <span class="s">"The first "</span> <span class="o">+</span> <span class="n">num</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">countResult</span><span class="o">;</span>
        <span class="c1">//该部分不启用消息保障机制，不需要锚定接收到的tuple</span>
		<span class="n">outputCollector</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="k">new</span> <span class="n">Values</span><span class="o">(</span><span class="n">countResult</span><span class="o">));</span> 
		<span class="n">outputCollector</span><span class="o">.</span><span class="na">ack</span><span class="o">(</span><span class="n">inputTuple</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">(</span><span class="n">Map</span> <span class="n">stormConf</span><span class="o">,</span> <span class="n">TopologyContext</span> <span class="n">context</span><span class="o">,</span> 
                        <span class="n">OutputCollector</span> <span class="n">collector</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">outputCollector</span> <span class="o">=</span> <span class="n">collector</span><span class="o">;</span>
		<span class="n">counterMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="n">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">declarer</span><span class="o">.</span><span class="na">declare</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"countResult"</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getComponentConfiguration</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/*
	 * 根据map的value对map进行排序
	 */</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">sortByMap</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">List</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">list</span> <span class="o">=</span> 
          	<span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;(</span><span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">());</span>
		<span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="k">new</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">o1</span><span class="o">,</span>
					<span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">o2</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">compareTo</span><span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">});</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><br /></p>

<p><strong>bolt3组件（负责实时打印单词统计结果）</strong></p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">wordcount</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.storm.topology.BasicOutputCollector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.OutputFieldsDeclarer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.topology.base.BaseBasicBolt</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Fields</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.storm.tuple.Tuple</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrintBolt</span> <span class="kd">extends</span> <span class="n">BaseBasicBolt</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
	
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Tuple</span> <span class="n">tuple</span><span class="o">,</span> <span class="n">BasicOutputCollector</span> <span class="n">collector</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">tuple</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">"，"</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="n">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">declarer</span><span class="o">.</span><span class="na">declare</span><span class="o">(</span><span class="k">new</span> <span class="n">Fields</span><span class="o">(</span><span class="s">"word"</span><span class="o">));</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><br /></p>

<p><strong>pom文件</strong></p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	<span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>com.keyllo.demo<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>zdemo-storm-wordcount<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>

	<span class="c">&lt;!-- 公共参数信息 --&gt;</span>
	<span class="nt">&lt;properties&gt;</span>
		<span class="nt">&lt;java.version&gt;</span>1.7<span class="nt">&lt;/java.version&gt;</span>
		<span class="nt">&lt;storm.version&gt;</span>1.1.0<span class="nt">&lt;/storm.version&gt;</span>
	<span class="nt">&lt;/properties&gt;</span>

	<span class="c">&lt;!-- 依赖包信息 --&gt;</span>
	<span class="nt">&lt;dependencies&gt;</span>
		<span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.apache.storm<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>storm-core<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;version&gt;</span>${storm.version}<span class="nt">&lt;/version&gt;</span>
			<span class="c">&lt;!-- keep storm out of the jar-with-dependencies --&gt;</span>
			<span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
		<span class="nt">&lt;/dependency&gt;</span>
	<span class="nt">&lt;/dependencies&gt;</span>


	<span class="c">&lt;!-- 构建配置信息 --&gt;</span>
	<span class="nt">&lt;build&gt;</span>
		<span class="nt">&lt;finalName&gt;</span>zdemo-storm-wordcount<span class="nt">&lt;/finalName&gt;</span>
		<span class="nt">&lt;plugins&gt;</span>
			<span class="c">&lt;!-- 编译插件 --&gt;</span>
			<span class="nt">&lt;plugin&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;version&gt;</span>3.5.1<span class="nt">&lt;/version&gt;</span>
				<span class="nt">&lt;configuration&gt;</span>
					<span class="nt">&lt;source&gt;</span>1.7<span class="nt">&lt;/source&gt;</span>
					<span class="nt">&lt;target&gt;</span>1.7<span class="nt">&lt;/target&gt;</span>
				<span class="nt">&lt;/configuration&gt;</span>
			<span class="nt">&lt;/plugin&gt;</span>

			<span class="c">&lt;!-- 使用shade打包 --&gt;</span>
			<span class="nt">&lt;plugin&gt;</span>  
			    <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>  
			    <span class="nt">&lt;artifactId&gt;</span>maven-shade-plugin<span class="nt">&lt;/artifactId&gt;</span>  
			    <span class="nt">&lt;version&gt;</span>2.3<span class="nt">&lt;/version&gt;</span>  
			    <span class="nt">&lt;executions&gt;</span>  
			        <span class="nt">&lt;execution&gt;</span>  
			            <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>  
			            <span class="nt">&lt;goals&gt;</span>  
			                <span class="nt">&lt;goal&gt;</span>shade<span class="nt">&lt;/goal&gt;</span>  
			            <span class="nt">&lt;/goals&gt;</span>  
			            <span class="nt">&lt;configuration&gt;</span>  
			                <span class="nt">&lt;transformers&gt;</span>  
			                    <span class="nt">&lt;transformer</span>  
			                        <span class="na">implementation=</span><span class="s">"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"</span><span class="nt">&gt;</span>  
			                        <span class="nt">&lt;mainClass&gt;</span>com.demo.wordcount.WordcountTopology<span class="nt">&lt;/mainClass&gt;</span>  
			                    <span class="nt">&lt;/transformer&gt;</span>  
			                    <span class="nt">&lt;transformer</span>  
			                        <span class="na">implementation=</span><span class="s">"org.apache.maven.plugins.shade.resource.AppendingTransformer"</span><span class="nt">&gt;</span>  
			                        <span class="nt">&lt;resource&gt;</span>META-INF/spring.handlers<span class="nt">&lt;/resource&gt;</span>  
			                    <span class="nt">&lt;/transformer&gt;</span>  
			                    <span class="nt">&lt;transformer</span>  
			                        <span class="na">implementation=</span><span class="s">"org.apache.maven.plugins.shade.resource.AppendingTransformer"</span><span class="nt">&gt;</span>  
			                        <span class="nt">&lt;resource&gt;</span>META-INF/spring.schemas<span class="nt">&lt;/resource&gt;</span>  
			                    <span class="nt">&lt;/transformer&gt;</span>  
			                <span class="nt">&lt;/transformers&gt;</span>  
			            <span class="nt">&lt;/configuration&gt;</span>  
			        <span class="nt">&lt;/execution&gt;</span>  
			    <span class="nt">&lt;/executions&gt;</span>  
			<span class="nt">&lt;/plugin&gt;</span>  
		<span class="nt">&lt;/plugins&gt;</span>

		<span class="nt">&lt;resources&gt;</span>
			<span class="nt">&lt;resource&gt;</span>
				<span class="nt">&lt;directory&gt;</span>src/main/resources<span class="nt">&lt;/directory&gt;</span>
				<span class="nt">&lt;filtering&gt;</span>true<span class="nt">&lt;/filtering&gt;</span>
				<span class="nt">&lt;includes&gt;</span>
					<span class="nt">&lt;include&gt;</span>**/*.xml<span class="nt">&lt;/include&gt;</span>
					<span class="nt">&lt;include&gt;</span>**/*.properties<span class="nt">&lt;/include&gt;</span>
				<span class="nt">&lt;/includes&gt;</span>
			<span class="nt">&lt;/resource&gt;</span>
		<span class="nt">&lt;/resources&gt;</span>
	<span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre>
</div>

<p><br /></p>

<p><strong>使用maven打包拓扑任务，并将其发布到集群环境</strong></p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># maven打包，生成zdemo-storm-wordcount.jar</span>
mvn clean package

<span class="c"># 将zdemo-storm-wordcount.jar上传到nimbus主机，执行以下命令启动拓扑任务</span>
xxx/bin/storm jar zdemo-storm-wordcount.jar com.demo.wordcount.WordCountTopology wordcount

<span class="c"># ok，大功告成</span>
</code></pre>
</div>

<p><br /></p>

<h3 id="storm的并发">storm的并发</h3>

<p>worker进程的并发度：表示拓扑任务由多少个worker进程来执行</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// 可以通过stormConfig来设置worker进程数(默认为1个)</span>
<span class="c1">// 一般情况下，最好一台机器上的一个topology只使用一个worker,主要原因时减少了worker之间的数据传输</span>
<span class="n">stormConfig</span><span class="o">.</span><span class="na">setNumWorkers</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</code></pre>
</div>

<p>executor线程的并发度：表示spout或bolt由多少个线程来执行</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">TopologyBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopologyBuilder</span><span class="o">();</span>
<span class="c1">//线程数为2</span>
<span class="n">builder</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="s">"randomSentenceSpout"</span><span class="o">,</span> <span class="k">new</span> <span class="n">RandomSentenceSpout</span><span class="o">(),</span> <span class="mi">2</span><span class="o">);</span> 

<span class="c1">//线程数为2，使用随机分组，订阅的消息为randomSentenceSpout</span>
<span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"wordNomalizerBolt"</span><span class="o">,</span> 
                <span class="k">new</span> <span class="nf">WordNomalizerBolt</span><span class="o">(),</span> <span class="mi">2</span><span class="o">).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"randomSentenceSpout"</span><span class="o">);</span>
</code></pre>
</div>

<p>task任务的并发度：表示n个task由m个executor线程来执行（并不是并发执行而是轮流执行！）</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">//表示该bolt有12个task来运行，12个task由3个executor线程来运行</span>
<span class="c1">//相当于每个executor线程要运行4个task，这4个task只能executor线程上轮流执行</span>
<span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"wordNomalizerBolt"</span><span class="o">,</span> 
                <span class="k">new</span> <span class="nf">WordNomalizerBolt</span><span class="o">(),</span> <span class="mi">3</span><span class="o">)</span>
  				<span class="o">.</span><span class="na">setNumTasks</span><span class="o">(</span><span class="mi">12</span><span class="o">)</span>
  				<span class="o">.</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"randomSentenceSpout"</span><span class="o">);</span> 
</code></pre>
</div>

<p><br /></p>

<h3 id="trident">Trident</h3>

<p><strong>概念</strong></p>

<ul>
  <li>它是storm高层次的抽象，在trident中保留了是spout组件，但是不再有bolt组件，将之前storm在bolt中实现的数据逻辑抽象成一系列的操作（operation），比如过滤、函数、分组统计等。当然在实际运行的过程中，trident还会将这些操作转换为bolt组件。</li>
  <li>trident封装好了消息可靠性保障机制。</li>
  <li>trident中有批次的概念，它可以将固定条数的tuple划分为一个个批次进行处理，每个批次都有一个有序的唯一编号，更新统计结果状态要严格按照批次顺序进行更新。</li>
  <li>由trident的批次概念，我们衍生出了trident的事务处理机制（类似于关系数据库事务控制的概念）。在trident中事务控制被划分为3个级别：
    <ul>
      <li>NON-Transactional：非事务控制，允许同一个批次内的tuple部分处理成功，失败的tuple可以在后面的其他多个批次内进行重试（也有可能不进行重试），可能会导致被成功处理多次</li>
      <li>Transactional：严格的事务控制，要求批次内处理失败的tuple只能在本批次内进行重试（即以相同的批次号进行重试，其他后面的批次需要等待你这次批次处理成功才能继续往下进行，如果tuple一直重试不成功，则就会将整个程序挂起），这种级别的事务是没有容错的事务控制。</li>
      <li>Opaque-Transactional：透明事务控制，针对Transactional事务控制的缺点设计。批次内的tuple梳理完</li>
    </ul>
  </li>
</ul>


                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                                <h5 style="display: inline;">Tags:</h5>
                                
                                    <button class="btn btn-white btn-xs" type="button">Linux</button>
                                
                        </div>
                        
                        <!--
                        <div class="col-md-6">
                            <div class="small text-right">
                                <div>    
                                    <i class="fa fa-comments-o"> </i> 
                                    <span class="ds-comments">0</span>条评论
                                </div>
                                <div>
                                    <i class="fa fa-share-alt"> </i> 
                                    <span class="ds-shares">0</span>条转发
                                </div>  
                            </div>
                        </div>
                        -->
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-lg-12">
                            <!-- donate -->
                            
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal2">
    Donate
</button>
<div class="modal inmodal" id="myModal2" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Donate Me</h4>
                <small class="font-bold">Thanks for your support!</small>
            </div>
            <div class="modal-body">
                <div class="tabbable" id="tabs-960227">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#panel-405278" data-toggle="tab">Alipay</a>
                        </li>
                        <li>
                            <a href="#panel-874705" data-toggle="tab">Wechat</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="panel-405278">
                            <div class="text-center">
                                <img src="/static/img/pay/alipay.png"" height="250" width="250">
                            </div>    
                        </div>
                        <div class="tab-pane" id="panel-874705">
                            <div class="text-center">
                                <img src="/static/img/pay/wechat.png"" height="250" width="250">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

                            
                            <br>
                            <!-- share -->
                            
                                
<!--分享-->
<div class="row" style="margin-top:30px;">
	<h2>Share:</h2>
    <div class="social-share" style="margin-left:-5px;"data-sites="wechat,qq,qzone,weibo"></div> 
</div>
<link rel="stylesheet" href="/static/css/share.min.css">
<script src="/static/js/jquery.share.min.js"></script>
<script src="/static/js/embed.js"></script>

<script>
  var url = 'http://localhost:4000/linux/2017/05/13/sotrm-base01.html';
  var source = 'http://localhost:4000/linux/2017/05/13/sotrm-base01.html';
  var title = 'Storm技术基础（一）';
  var excerpt = $("p:eq(0)").text();
  
  var imageUrl = 'http://localhost:4000/static/img/landing/header_one.jpg';
  var imgEle = $(".content_img:eq(0)");
  if (imgEle) {
    imageUrl = imgEle.attr("src");
  }

  var $config = {
      url: url, // 网址，默认使用 window.location.href
      source: source, // 来源（QQ空间会用到）, 默认读取head标签：<meta name="site" content="http://overtrue" />
      title: title, // 标题，默认读取 document.title 或者 <meta name="title" content="share.js" />
      description: excerpt, // 描述, 默认读取head标签：<meta name="description" content="PHP弱类型的实现原理分析" />
      image: imageUrl, // 图片, 默认取网页中第一个img标签
      sites: ['qzone', 'qq', 'weibo','wechat','douban'], // 启用的站点
      //disabled: ['google', 'facebook', 'twitter'], // 禁用的站点
      wechatQrcodeTitle: "微信扫一扫：分享", // 微信二维码提示文字
      wechatQrcodeHelper: '<p style="font-size:10px;">微信里点“发现”，扫一下</p><p style="font-size:10px;">二维码便可将本文分享至朋友圈。</p>',
   };
  $('.social-share').share($config);
</script>




                            
                            <br>
                            <!-- comment -->
                            <!--



-->

<!-- 多说评论框 start -->
<div class="row" style="margin-top:25px;"></div>
<div class="ds-thread" data-thread-key="/linux/2017/05/13/sotrm-base01.html" data-title="Storm技术基础（一）" data-url="http://localhost:4000/linux/2017/05/13/sotrm-base01.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
	var duoshuoQuery = {short_name:"kinglyjn"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
<!-- 多说公共JS代码 end -->



                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>



	
	    <script src="/static/js/scroll.js"></script>

<!-- Baidu analytics -->


<!-- Google analytics -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-73784599-1', 'auto');
    ga('send', 'pageview');

  </script>


<!--

-->

<!--

-->

<script async src="/static/js/count_page.js"></script>

	

</body>
</html>