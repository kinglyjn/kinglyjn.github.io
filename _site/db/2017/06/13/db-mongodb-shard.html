<!DOCTYPE html>
<html>
	
	    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
    <meta content="mongodb分片技技术" name="description">
  
  
    <meta name="keywords" content="mongodb shard,mongodb分片,kinglyjn,张庆力">
  
  <meta name="author" content="KinglyJn">

  <title>
    
        KinglyJn|mongodb分片技技术
    
  </title>
  <!-- favicon -->
  <link rel="shortcut icon" href="/static/img/favicon.ico">


  <!-- Third-party CSS -->
  <link href="/bower_components/normalize-css/normalize.min.css" rel="stylesheet">
  <link href="/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/bower_components/animate.css/animate.min.css" rel="stylesheet">
  <link href="/bower_components/components-font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="/static/font-mfizz/font-mfizz.css" rel="stylesheet">
  <!-- <link href="/bower_components/toastr/toastr.min.css" rel="stylesheet"> -->
  <link href="/bower_components/jquery.gritter/css/jquery.gritter.css" rel="stylesheet">
  <link rel="stylesheet" href="/search/css/cb-search.css">

  <!-- Custom styles for this template -->
  <link href="/static/css/style.min.css" rel="stylesheet">
  <link href="/static/css/pygments.css" rel="stylesheet">

  <!-- Scripts -->
  <script src="/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/search/js/bootstrap3-typeahead.min.js"></script>

  <!-- cb-search -->
  <script src="/search/js/cb-search.js"></script>
  <script>
    $(function(){
        $("pre").css('display','block');
    });
  </script>
  <!-- Mainly scripts -->
  <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="/bower_components/metisMenu/dist/metisMenu.min.js"></script>
  <script src="/bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>

  <!-- Peity -->
  <script src="/bower_components/peity/jquery.peity.min.js"></script>

  <script src="/bower_components/PACE/pace.min.js"></script>
  <script src="/bower_components/wow/dist/wow.min.js"></script>
  <!-- Custom and plugin javascript -->
  <script src="/static/js/inspinia.js"></script>

  <!-- Rickshaw -->
  <script src="/bower_components/rickshaw/vendor/d3.v3.js"></script>
  <script src="/bower_components/rickshaw/rickshaw.min.js"></script>


  <!-- jPages -->
  <script src="/static/js/jPages.js"></script>
  <script src="/static/js/js.js"></script>
  <script type="text/javascript">
        $(function(){
          /* initiate the plugin */
          $("div.pag-holder").jPages({
              containerID  : "pag-itemContainer",
              perPage      : 10,  /* num of items per page */
              startPage    : 1,
              startRange   : 1,
              midRange     : 3,
              endRange     : 1
          });

          $("div.pag-jump button").click(function(){
            var page = parseInt($("div.pag-jump input").val());
            $("div.pag-holder").jPages(page);
          });

          $("div.pag-jump input").on("keypress", function(){
            var e=e||window.event;
            if (e.keyCode == 13) {
                var page = parseInt($("div.pag-jump input").val());
                $("div.pag-holder").jPages(page);
            } 
          });
      });
  </script>

<!-- GrowingIO -->

  <script>
    var _vds = _vds || [];
    window._vds = _vds;
    (function(){
      _vds.push(['setAccountId', 'a49d4901c7853da9']);
      (function() {
        var vds = document.createElement('script');
        vds.type='text/javascript';
        vds.async = true;
        vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(vds, s);
      })();
    })();
  </script>


</head>

	


<body id="page-top" class="landing-page">

	
	    

<!--修复手机端横轴方向左右滑动BUG-->
<style type="text/css">
    .landing-page .row {
        margin-left: 0px;
        margin-right: 0px;
    }
</style>

<div class="search-tool"
      style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
    <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog">

    <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;">
        <img src="/search/img/cb-close.png" id="close-btn"/>
    </div>
</div>

<div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;">
    <img src="/search/img/cb-search.png"  id="search-btn"  title="Double click Ctrl"/>
</div>

<div class="navbar-wrapper">
        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header page-scroll">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">KinglyJn</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a class="page-scroll" href="/blog/"></a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/blog/">Blog</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/linux/">Linux</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/cloud/">Cloud</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/java/">Java</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/c/">C</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/php/">PHP</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/db/">DB</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/htmlx/">HTMLX</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/life/">Life</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/art/">Art</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/other/">Other</a></li>
                        
                    </ul>
                </div>
            </div>
        </nav>
</div>
<div id="inSlider" class="carousel carousel-fade" data-ride="carousel">
    <div style="position:absolute;float:left;left:25%;z-index:15;width:50%;margin-bottom:18%;bottom:0;text-align:center;list-style:none;">
        <span style="color:white;font-size:24px;">以平实之心写作</span><br>
        <span style="color:white;font-size:13px;">writing with simple heart ♬. </span>
    </div>
    <!--
    <ol class="carousel-indicators">
        <li data-target="#inSlider" data-slide-to="0" class="active"></li>
        <li data-target="#inSlider" data-slide-to="1"></li>
    </ol>
    -->
    <div class="carousel-inner" role="listbox">
        <div class="item active">
            <div class="container">
                <div class="carousel-caption">
                </div>
                <div class="carousel-image wow zoomIn">
                    <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> -->
                </div>
            </div>
            <!-- Set background for slide in css -->
            <div class="header-back blog-one"></div>
        </div>
        <!--
        <div class="item">
            <div class="container">
                <div class="carousel-caption blank">
                </div>
            </div>
            Set background for slide in css
            <div class="header-back two"></div>
        </div>
        -->
    </div>
    <!--
    <a class="left carousel-control" href="#inSlider" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
    </a>
    <a class="right carousel-control" href="#inSlider" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
    </a>
    -->
</div>


	

    <div class="wrapper wrapper-content  animated fadeInRight article">
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="ibox">
                <div class="ibox-content">
                    <div class="pull-right">
                    	
                        	<button class="btn btn-white btn-xs" type="button">DB</button>
                        
                    </div>
                    <div class="text-center article-title" style="margin-bottom:50px;">
                        <h1>
                            mongodb分片技技术
                        </h1>
                        <a href="http://www.keyllo.com/studio/">
                            <span class="text-muted"><i class="fa fa-user"></i> KinglyJn</span>
                        </a>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <span class="text-muted"><i class="fa fa-clock-o"></i> 2017-06-13</span>
                    </div>
                    	<h3 id="mongodb分片技技术">mongodb分片技技术</h3>

<blockquote>
  <p>注意：MongoDB 3.4, config servers must be deployed as a replica set (CSRS).</p>

  <p>也就是说mongodb3.4以后【config节点】强制使用副本集。</p>
</blockquote>

<p><strong>什么是分片？</strong>
分片是将数据进行拆分，将数据水平地分散到不同服务器的技术。</p>

<p><img src="http://img.blog.csdn.net/20170609135819836?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQva2luZ2x5am4=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" style="width:70%" /></p>

<p><strong>为什么要分片？</strong></p>

<p>架构上：读写均衡，去中心化。</p>

<p>硬件上：解决单机内存和硬盘的限制。</p>

<p>总的来说，分片能够改善单台机器数据的存储以及数据吞吐性能，提高在大量数据下随机访问的性能。</p>

<p><strong>分片和副本集的比较</strong></p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>replication（副本集）</th>
      <th>shard（分片）</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>实现意义</td>
      <td>数据冗余、实现读写分离（主写副读），提升读的性能</td>
      <td>提升并发性能</td>
    </tr>
    <tr>
      <td>架构上</td>
      <td>中心化</td>
      <td>水平化</td>
    </tr>
    <tr>
      <td>实现原理上</td>
      <td>数据镜像</td>
      <td>数据打散分布</td>
    </tr>
    <tr>
      <td>维护成本</td>
      <td>相对容易</td>
      <td>相对较高</td>
    </tr>
  </tbody>
</table>

<p><strong>分片节点介绍</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">节点</th>
      <th style="text-align: left">说明</th>
      <th>启动命令</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">mongos节点</td>
      <td style="text-align: left">接收前端请求，进行对应消息的路由</td>
      <td>mongos –configdb configdbserver:27017</td>
    </tr>
    <tr>
      <td style="text-align: left">config节点</td>
      <td style="text-align: left">存储元数据，为路由节点mongos服务，将数据路由到shared</td>
      <td>mongod –configsvr –rpelSet 副本集</td>
    </tr>
    <tr>
      <td style="text-align: left">shard节点</td>
      <td style="text-align: left">存储数据的节点（单个mongod或副本集）</td>
      <td>mongod –shardsvr</td>
    </tr>
  </tbody>
</table>

<p>结构如下：</p>

<pre><code class="language-default">app—&gt;mongos----&gt;CONFIG_RS[config]----&gt;RS01[shard01、shard02、shard03...]
					             ----&gt;RS02[shard01、shard02、shard03...]
					             ----&gt;RS03[shard01、shard02、shard03...]				    
</code></pre>

<p><strong>分片测试细节</strong></p>

<p>分片节点信息：</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># 分片节点信息：</span>
172.16.127.128		mongos
172.16.127.129		<span class="o">[</span>config_rs]configsvr0,configsvr1,configsvr2
172.16.127.130		shardsvr01
172.16.127.131		shardsvr02


<span class="c"># 配置信息</span>
----------------------------
<span class="c">#shardsvr配置文件mongod.conf</span>
port <span class="o">=</span> 27017
dbpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4/data
logpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4/logs/mongod.log
logappend <span class="o">=</span> <span class="nb">true
</span>fork <span class="o">=</span> <span class="nb">true
</span>auth <span class="o">=</span> <span class="nb">false</span>

<span class="c">#config_rs配置文件mongod.conf</span>
port <span class="o">=</span> 27017
dbpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4/data
logpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4/logs/mongod.log
logappend <span class="o">=</span> <span class="nb">true
</span>fork <span class="o">=</span> <span class="nb">true
</span>auth <span class="o">=</span> <span class="nb">false

</span>port <span class="o">=</span> 27018
dbpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4-01/data
logpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4-01/logs/mongod.log
logappend <span class="o">=</span> <span class="nb">true
</span>fork <span class="o">=</span> <span class="nb">true
</span>auth <span class="o">=</span> <span class="nb">false

</span>port <span class="o">=</span> 27019
dbpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4-02/data
logpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4-02/logs/mongod.log
logappend <span class="o">=</span> <span class="nb">true
</span>fork <span class="o">=</span> <span class="nb">true
</span>auth <span class="o">=</span> <span class="nb">false</span>

<span class="c">#mongos配置文件mongod.conf</span>
port <span class="o">=</span> 27017
logpath <span class="o">=</span> /home/ubuntu/mongodb-3.4.4/logs/mongod.log
logappend <span class="o">=</span> <span class="nb">true
</span>fork <span class="o">=</span> <span class="nb">true</span>
</code></pre>
</div>

<p>启动各个分片节点</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># shardsvr01 &amp; shardsvr02</span>
mongodb-3.4.4/bin/mongod -f mongodb-3.4.4/conf/mongod.conf --shardsvr
mongodb-3.4.4/bin/mongod -f mongodb-3.4.4/conf/mongod.conf --shardsvr

<span class="c"># configsvr(正常应该配置至少三个configsvr)</span>
mongodb-3.4.4/bin/mongod -f mongodb-3.4.4/conf/mongod.conf --configsvr --replSet config_rs
mongodb-3.4.4-01/bin/mongod -f xxx/conf/mongod.conf --configsvr --replSet config_rs
mongodb-3.4.4-02/bin/mongod -f xxx/conf/mongod.conf --configsvr --replSet config_rs
<span class="c"># 初始化CONFIG_RS</span>
use admin
var config <span class="o">=</span> <span class="o">{</span>_id:<span class="s2">"config_rs"</span>, configsvr:true,members:[<span class="o">{</span>_id:0, host:<span class="s2">"172.16.127.129:27017"</span><span class="o">}]}</span>
rs.initiate<span class="o">(</span>config<span class="o">)</span>
rs.add<span class="o">({</span>_id:1, host:<span class="s2">"172.16.127.129:27018"</span><span class="o">})</span>
rs.add<span class="o">({</span>_id:2, host:<span class="s2">"172.16.127.129:27019"</span><span class="o">})</span>

<span class="c"># mongos</span>
mongodb-3.4.4/bin/mongos -f mongodb-3.4.4/conf/mongod.conf --configdb config_rs/172.16.127.129:27017,172.16.127.129:27018,172.16.127.129:27019
</code></pre>
</div>

<p>给具体的库表添加分片：</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c">#1. 连接到mongos</span>
	mongodb-3.4.4/bin/mongo
	use admin
	
<span class="c">#2. add shard [需要在admin数据库下操作]</span>
	<span class="c">#注意如果你的mongos和shard在同一台机器上，添加分片不能使用localhost，建议使用ip</span>
	<span class="c">#对于单个数据库实例,maxSize表示分片节点最大存储大小</span>
	<span class="c">#db.runCommand({addShard:"&lt;hostname&gt;&lt;:port&gt;", maxSize:&lt;size&gt;, name:"&lt;shard_name&gt;"})</span>
	<span class="c">#对于副本集群</span>
	<span class="c">#db.runCommand({addShard:"&lt;replica_set&gt;/&lt;hostname&gt;&lt;:port&gt;", </span>
	<span class="c">#				maxSize:&lt;size&gt;, name:"&lt;shard_name&gt;"})</span>
	db.runCommand<span class="o">({</span>addShard:<span class="s2">"172.16.127.130:27017"</span><span class="o">})</span>
	db.runCommand<span class="o">({</span>addShard:<span class="s2">"172.16.127.131:27017"</span><span class="o">})</span>
	<span class="c">#或者</span>
	sh.addShard<span class="o">(</span><span class="s1">'172.16.127.130:27017'</span><span class="o">)</span>
	sh.addShard<span class="o">(</span><span class="s1">'172.16.127.131:27017'</span><span class="o">)</span>
	sh.status<span class="o">()</span>
	sh.status<span class="o">({</span>verbose:true<span class="o">})</span>
	
<span class="c">#3. enable sharding [admin，这里只是标识这个数据库可以启用分片，但实际上并没有进行分片]</span>
	db.runCommand<span class="o">({</span>enableSharding:<span class="s2">"&lt;dbname&gt;"</span><span class="o">})</span>
	<span class="c">#或者(启用test库的分片)</span>
	sh.enableSharding<span class="o">(</span><span class="s1">'test'</span><span class="o">)</span>

<span class="c">#4. 对一个集合进行分片(key为片件，指定为片件的字段需要索引，punique表示对shard-key的唯一性的约束)</span>
	db.user.ensureIndex<span class="o">({</span>name:1<span class="o">})</span>
	db.runCommand<span class="o">({</span>shardcollection:<span class="s2">"dbname.cname"</span>, key:<span class="o">{</span><span class="s2">"userid"</span>:1<span class="o">}</span>, unique:&lt;<span class="nb">true</span>/false&gt;<span class="o">})</span>
	<span class="c">#或者</span>
	db.user.ensureIndex<span class="o">({</span>name:1<span class="o">})</span>
    sh.shardCollection<span class="o">(</span><span class="s2">"test.user"</span>, <span class="o">{</span>name:1<span class="o">})</span>

<span class="c">#5. 如果要加验证，官网说只要在mongos上操作即可，简单地添加一个用户：</span>
    use <span class="nb">test
    </span>db.createUser<span class="o">({</span>
        user:<span class="s1">'test'</span>,
        <span class="nb">pwd</span>:<span class="s1">'123456'</span>,
        roles:[
            <span class="o">{</span>role:<span class="s1">'readWrite'</span>,db:<span class="s1">'test'</span><span class="o">}</span>
        <span class="o">]</span>
    <span class="o">})</span>

<span class="c">#分片测试</span>
<span class="c">#1.查看集合状态</span>
db.shard_cname.stats<span class="o">()</span>
<span class="c">#2.查看分片状态</span>
db.printShardingStatus<span class="o">()</span>
<span class="c">#3.在mongos节点插入数据</span>
<span class="c">#for(var i=0; i&lt;1000; i++) db.user.insert({name:String.fromCharCode(i%26+97), age:i})</span>
<span class="k">for</span> <span class="o">(</span>var <span class="nv">i</span><span class="o">=</span>0; i&lt;1000; i++<span class="o">)</span> db.user.insert<span class="o">({</span>name:<span class="s2">"zhangsan"</span>+i, age:i<span class="o">})</span>
<span class="k">for</span> <span class="o">(</span>var <span class="nv">i</span><span class="o">=</span>0; i&lt;1000; i++<span class="o">)</span> db.user.insert<span class="o">({</span>name:<span class="s2">"lisi"</span>+i, age:i<span class="o">})</span>
<span class="c">#4.查看shard01和shard02两个节点，可以看到数据已经均摊到这两个节点上了(mongos节点上是不保存插入数据的)</span>
db.user.find<span class="o">()</span>
</code></pre>
</div>

<p>删除分片</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c">#删除分片(在mongos节点操作)</span>
use admin
<span class="c">#下面这句会立即返回，实际在后台执行</span>
db.runCommand<span class="o">({</span>removeshard:<span class="s2">"172.16.127.130:27017"</span><span class="o">})</span>
<span class="c">#我们可以反复执行上面语句，查看执行结果</span>
db.runCommand<span class="o">({</span>removeshard:<span class="s2">"172.16.127.130:27017"</span><span class="o">})</span>
<span class="o">{</span> msg: <span class="s2">"draining ongoing"</span> , state: <span class="s2">"ongoing"</span>, remaining: <span class="o">{</span> chunks: 42, dbs : 1 <span class="o">}</span>, ok: 1 <span class="o">}</span>
<span class="c">#从上面可以看到，正在迁移，还剩下42块没迁移完，当remain为0之后，这一步就结束了，因为我们有两个分片节点，shard01从集群被移除之后，shard01（1002条）的分片数据全部被迁往到了shard02(1001+1002条)，但是shard01物理节点上的数据背不会被删除</span>

<span class="c">#有一些分片上保存上一些unsharded data，需要迁移到其他分片上，</span>
<span class="c">#可以用sh.status()查看分片上是否有unsharded data，如果有则显示：</span>
<span class="o">{</span>  <span class="s2">"_id"</span> : <span class="s2">"test"</span>,  <span class="s2">"primary"</span> : <span class="s2">"shard0000"</span>,  <span class="s2">"partitioned"</span> : <span class="nb">true</span> <span class="o">}</span>

<span class="c">#用下面的命令迁移(只有全部迁移完上面的命令才会返回，执行完毕后shard01的未分片的1002条数据也被删除了)</span>
<span class="gp">mongos&gt; </span>db.runCommand<span class="o">({</span>movePrimary:<span class="s2">"test"</span>, to:<span class="s2">"shard0001"</span><span class="o">})</span>
shards:
        <span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"shard0000"</span>, <span class="s2">"host"</span>:<span class="s2">"172.16.127.130:27017"</span>, <span class="s2">"state"</span>:1, <span class="s2">"draining"</span>: <span class="nb">true</span> <span class="o">}</span>
        <span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"shard0001"</span>, <span class="s2">"host"</span>:<span class="s2">"172.16.127.131:27017"</span>, <span class="s2">"state"</span>:1 <span class="o">}</span>
databases:
		<span class="o">{</span> <span class="s2">"primary"</span> : <span class="s2">"shard0001:172.16.127.131:27017"</span>, <span class="s2">"ok"</span> : 1 <span class="o">}</span>

<span class="c">#最后运行命令进行彻底删除</span>
db.runCommand<span class="o">({</span>removeshard:<span class="s2">"172.16.127.130:27017"</span><span class="o">})</span>
sh.status<span class="o">()</span>
shards:
        <span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"shard0001"</span>, <span class="s2">"host"</span>:<span class="s2">"172.16.127.131:27017"</span>, <span class="s2">"state"</span>:1<span class="o">}</span>
databases:
		<span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"test"</span>, <span class="s2">"primary"</span>:<span class="s2">"shard0001"</span>, <span class="s2">"partitioned"</span>:true <span class="o">}</span>
</code></pre>
</div>

<p>添加被删除的分片</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c">#重新添加刚才删除的分片，将遇到以下错误，提示test数据库已经存在</span>
db.runCommand<span class="o">({</span>addShard:<span class="s2">"172.16.127.130:27017"</span><span class="o">})</span>
<span class="o">{</span>
  <span class="s2">"code"</span> : 96,
  <span class="s2">"ok"</span> : 0,
  <span class="s2">"errmsg"</span> : <span class="s2">"can't add shard '172.16.127.130:27017' 
  "</span>because a <span class="nb">local </span>database <span class="s1">'test'</span> exists <span class="k">in </span>another shard0001<span class="s2">"
}
#这时，就需要通过MongoDB shell连接到shard01实例，删除test数据库，然后重新添加
use test
db.dropDatabase()
#回到mongos节点
use admin
mongos&gt; sh.addShard('172.16.127.130:27017')
{
        "</span>code<span class="s2">" : 11000,
        "</span>ok<span class="s2">" : 0,
        "</span>errmsg<span class="s2">" : "</span>E11000 duplicate key error collection: 
        	<span class="s2">"admin.system.version index: _id_ dup key: { : </span><span class="se">\"</span><span class="s2">shardIdentity</span><span class="se">\"</span><span class="s2"> }"</span>
<span class="o">}</span>
<span class="c">#这时候再连接到shard01节点，删除admin.system.version集合中记录</span>
db.system.version.remove<span class="o">({})</span>
db.system.version.remove<span class="o">({</span><span class="s2">"_id"</span>:<span class="s2">"shardIdentity"</span><span class="o">})</span>
WriteResult<span class="o">({</span>
        <span class="s2">"nRemoved"</span> : 0,
        <span class="s2">"writeError"</span> : <span class="o">{</span>
                <span class="s2">"code"</span> : 40070,
                <span class="s2">"errmsg"</span> : <span class="s2">"cannot delete shardIdentity document while in --shardsvr mode"</span>
        <span class="o">}</span>
<span class="o">})</span>
<span class="c">#删除时报错，意思是说不能在分片模式下删除这张表中的这条记录，然后我们关闭shard01，然后以非shardsvr的方式启动，删除这条记录后，再以shardsvr方式启动</span>
db.shutdownServer<span class="o">()</span>
mongodb-3.4.4/bin/mongod -f mongodb-3.4.4/conf/mongod.conf 
use admin
db.system.version.remove<span class="o">({})</span>
db.shutdownServer<span class="o">()</span>
mongodb-3.4.4/bin/mongod -f mongodb-3.4.4/conf/mongod.conf --shardsvr
<span class="c">#最后添加之前被删除的分片shard01，大功告成</span>
db.runCommand<span class="o">({</span>addShard:<span class="s2">"172.16.127.130:27017"</span><span class="o">})</span>
<span class="o">{</span> <span class="s2">"shardAdded"</span> : <span class="s2">"shard0002"</span>, <span class="s2">"ok"</span> : 1 <span class="o">}</span>
</code></pre>
</div>

<p>哈希分片（hash key）</p>

<p>分片过程中利用哈希索引作为分片的单个键。</p>

<ul>
  <li>哈希分片的片件只能使用一个字段</li>
  <li>哈希片件的最大好处就是能够保证数据在各个分片节点分布基本均匀</li>
</ul>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c">#连接mongos，在原来test分片库的基础上新建userid_hash集合，并插入数据</span>
db.userid_hash.insert<span class="o">({</span>userid:11<span class="o">})</span>
db.userid_hash.insert<span class="o">({</span>userid:22<span class="o">})</span>

<span class="c">#hash分片之前需要为相关字段建立hash索引(索引名称默认为"userid_hashed"形式)</span>
db.userid_hash.ensureIndex<span class="o">({</span>userid:<span class="s2">"hashed"</span><span class="o">})</span>

<span class="c">#切换到admin库，对test.userid_hash进行hash分片</span>
use admin
sh.shardCollection<span class="o">(</span><span class="s2">"test.userid_hash"</span>, <span class="o">{</span>userid:<span class="s2">"hashed"</span><span class="o">})</span>

<span class="c">#测试分片</span>
use <span class="nb">test
</span><span class="k">for</span> <span class="o">(</span>var <span class="nv">i</span><span class="o">=</span>0; i&lt;1000; i++<span class="o">)</span> db.userid_hash.insert<span class="o">({</span>userid:i<span class="o">})</span>
</code></pre>
</div>

<p>关于两个概念的说明：</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>片件（shardid）：
当设置分片时，需要从集合里面选择一个或几个键，把选择出来的键作为数据拆分的依据，这个键叫做片键或复合片键。选好片键后，MongoDB将不允许插入没有片键的文档，但是允许不同文档的片键类型不一样。片件的好坏跟大程度上影响集群的性能、容量和功能。
&gt;如果片件的重复性很强，就会导致数据块不容易拆分，容易造成大的数据块，导致数据分布不均匀。
&gt;如果片件是单调递增的_id或时间戳，这样会导致你一直往最后一个副本集中添加数据，比较合适的片件一般是复合片件，形式如<span class="o">{</span>node:1,time:1<span class="o">}</span>

块（chunk）：
在一个shard server内部，MongoDB还是会把数据分为chunks，每个chunk（默认64m）代表这个shard server内部一部分数据。chunk的产生，会有以下两个用途：
	- Splitting：当一个chunk的大小超过配置中的chunk size时，MongDB的后台
				进程会把这个chunk切分成更小的chunk，从而避免chunk过大的情况
	- Balancing：在MongoDB中，balancer是一个后台进程，负责chunk的迁移，
				从而均衡各个shard server的负载
</code></pre>
</div>

<p>数据块的拆分（split）和均衡(balance)：</p>

<p><img src="http://img.blog.csdn.net/20170613104216695?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQva2luZ2x5am4=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" style="width:100%" /></p>

<p><img src="http://img.blog.csdn.net/20170613104311181?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQva2luZ2x5am4=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" style="width:100%" /></p>

<p><strong>手动分片</strong></p>

<p>目的：为了减少自动平衡过程中带来的io等资源的消耗。</p>

<p>前提：关闭auto balance，充分了解数据并对数据进行预先划分。</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c">#步骤一，关闭自动平衡(开启使用sh.startBalancer)，此时平衡器状态为 Currently enabled:no</span>
sh.stopBalancer<span class="o">()</span>

<span class="c">#步骤二，预分配空chunk，这是一种提高写效率的方法。</span>
<span class="c">#相当于在写入真实数据之前，就分配好了数据桶，然后再对号入座。省去了创建chunk和split的时间。</span>
<span class="c">#格式 db.adminCommand({split:&lt;database&gt;.&lt;collection&gt;, &lt;find|middle|bounds&gt;})</span>
<span class="c">#find 表示查找到的记录进行分裂</span>
<span class="c">#bounds是指定[low, up]分裂</span>
<span class="c">#middle是指定分裂的点</span>
<span class="c">#一个预分配chunk的例子如下</span>
<span class="c">#这个预分配的目的是字母顺序有一定间隔的email， 分配到不同的chunk里。</span>
<span class="c">#例如aa-ag到一个chunk，ag-am到一个chunk</span>
use admin
sh.enableSharding<span class="o">(</span><span class="s1">'test'</span><span class="o">)</span>
db.user_email.ensureIndex<span class="o">({</span>email:1<span class="o">})</span>
sh.shardCollection<span class="o">(</span><span class="s2">"test.user_email"</span>, <span class="o">{</span>email:1<span class="o">})</span>
<span class="k">for</span> <span class="o">(</span>var <span class="nv">i</span><span class="o">=</span>97; i&lt;97+26; i++<span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span>var <span class="nv">j</span><span class="o">=</span>97;j&lt;97+26; j+<span class="o">=</span>6<span class="o">)</span> <span class="o">{</span>
    var prefix <span class="o">=</span> String.fromCharCode<span class="o">(</span>i<span class="o">)</span>+String.fromCharCode<span class="o">(</span>j<span class="o">)</span>;
    sh.splitAt<span class="o">(</span><span class="s2">"test.user_email"</span>, <span class="o">{</span>email:prefix<span class="o">})</span>;
  <span class="o">}</span>
<span class="o">}</span>

<span class="c">#步骤三，定义shServer，手动移动分割快（moveChunk）</span>
<span class="c">#db.adminCommand({moveChunk:"test.user_email",</span>
<span class="c">#	find:{email:prefix}, to:shServer[(j-97)%2]})</span>
var shServers <span class="o">=</span> <span class="o">[</span><span class="s2">"172.16.127.130:27017"</span>, <span class="s2">"172.16.127.130:27017"</span><span class="o">]</span>;
<span class="k">for</span> <span class="o">(</span>var <span class="nv">i</span><span class="o">=</span>97; i&lt;97+26; i++<span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span>var <span class="nv">j</span><span class="o">=</span>97;j&lt;97+26; j+<span class="o">=</span>2<span class="o">)</span> <span class="o">{</span>
    var prefix <span class="o">=</span> String.fromCharCode<span class="o">(</span>i<span class="o">)</span>+String.fromCharCode<span class="o">(</span>j<span class="o">)</span>;
    sh.moveChunk<span class="o">(</span><span class="s2">"test.user_email"</span>, <span class="o">{</span>email:prefix<span class="o">}</span>, shServers[<span class="o">(</span>j-97<span class="o">)</span>%2]<span class="o">)</span>;
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                                <h5 style="display: inline;">Tags:</h5>
                                
                                    <button class="btn btn-white btn-xs" type="button">DB</button>
                                
                                    <button class="btn btn-white btn-xs" type="button">mongodb</button>
                                
                        </div>
                        
                        <!--
                        <div class="col-md-6">
                            <div class="small text-right">
                                <div>    
                                    <i class="fa fa-comments-o"> </i> 
                                    <span class="ds-comments">0</span>条评论
                                </div>
                                <div>
                                    <i class="fa fa-share-alt"> </i> 
                                    <span class="ds-shares">0</span>条转发
                                </div>  
                            </div>
                        </div>
                        -->
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-lg-12">
                            <!-- donate -->
                            
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal2">
    Donate
</button>
<div class="modal inmodal" id="myModal2" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Donate Me</h4>
                <small class="font-bold">Thanks for your support!</small>
            </div>
            <div class="modal-body">
                <div class="tabbable" id="tabs-960227">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#panel-405278" data-toggle="tab">Alipay</a>
                        </li>
                        <li>
                            <a href="#panel-874705" data-toggle="tab">Wechat</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="panel-405278">
                            <div class="text-center">
                                <img src="/static/img/pay/alipay.png"" height="250" width="250">
                            </div>    
                        </div>
                        <div class="tab-pane" id="panel-874705">
                            <div class="text-center">
                                <img src="/static/img/pay/wechat.png"" height="250" width="250">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

                            
                            <br>
                            <!-- share -->
                            
                                
<!--分享-->
<div class="row" style="margin-top:30px;">
	<h2>Share:</h2>
    <div class="social-share" style="margin-left:-5px;"data-sites="wechat,qq,qzone,weibo"></div> 
</div>
<link rel="stylesheet" href="/static/css/share.min.css">
<script src="/static/js/jquery.share.min.js"></script>
<script src="/static/js/embed.js"></script>

<script>
  var url = 'http://localhost:4000/db/2017/06/13/db-mongodb-shard.html';
  var source = 'http://localhost:4000/db/2017/06/13/db-mongodb-shard.html';
  var title = 'mongodb分片技技术';
  var excerpt = $("p:eq(0)").text();
  
  var imageUrl = 'http://localhost:4000/static/img/landing/header_one.jpg';
  var imgEle = $(".content_img:eq(0)");
  if (imgEle) {
    imageUrl = imgEle.attr("src");
  }

  var $config = {
      url: url, // 网址，默认使用 window.location.href
      source: source, // 来源（QQ空间会用到）, 默认读取head标签：<meta name="site" content="http://overtrue" />
      title: title, // 标题，默认读取 document.title 或者 <meta name="title" content="share.js" />
      description: excerpt, // 描述, 默认读取head标签：<meta name="description" content="PHP弱类型的实现原理分析" />
      image: imageUrl, // 图片, 默认取网页中第一个img标签
      sites: ['qzone', 'qq', 'weibo','wechat','douban'], // 启用的站点
      //disabled: ['google', 'facebook', 'twitter'], // 禁用的站点
      wechatQrcodeTitle: "微信扫一扫：分享", // 微信二维码提示文字
      wechatQrcodeHelper: '<p style="font-size:10px;">微信里点“发现”，扫一下</p><p style="font-size:10px;">二维码便可将本文分享至朋友圈。</p>',
   };
  $('.social-share').share($config);
</script>




                            
                            <br>
                            <!-- comment -->
                            <!--



-->

<!-- 多说评论框 start -->
<div class="row" style="margin-top:25px;"></div>
<div class="ds-thread" data-thread-key="/db/2017/06/13/db-mongodb-shard.html" data-title="mongodb分片技技术" data-url="http://localhost:4000/db/2017/06/13/db-mongodb-shard.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
	var duoshuoQuery = {short_name:"kinglyjn"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
<!-- 多说公共JS代码 end -->



                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>



	
	    <script src="/static/js/scroll.js"></script>

<!-- Baidu analytics -->


<!-- Google analytics -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-73784599-1', 'auto');
    ga('send', 'pageview');

  </script>


<!--

-->

<!--

-->

<script async src="/static/js/count_page.js"></script>

	

</body>
</html>