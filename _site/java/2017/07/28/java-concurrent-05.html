<!DOCTYPE html>
<html>
	
	    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
    <meta content="并发编程之连接池的设计" name="description">
  
  
    <meta name="keywords" content="并发编程之连接池的设计,java,kinglyjn,张庆力">
  
  <meta name="author" content="KinglyJn">

  <title>
    
        KinglyJn|并发编程之连接池的设计
    
  </title>
  <!-- favicon -->
  <link rel="shortcut icon" href="static/img/favicon.ico">


  <!-- Third-party CSS -->
  <link href="/bower_components/normalize-css/normalize.min.css" rel="stylesheet">
  <link href="/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/bower_components/animate.css/animate.min.css" rel="stylesheet">
  <link href="/bower_components/components-font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="/static/font-mfizz/font-mfizz.css" rel="stylesheet">
  <!-- <link href="/bower_components/toastr/toastr.min.css" rel="stylesheet"> -->
  <link href="/bower_components/jquery.gritter/css/jquery.gritter.css" rel="stylesheet">
  <link rel="stylesheet" href="/search/css/cb-search.css">

  <!-- Custom styles for this template -->
  <link href="/static/css/style.min.css" rel="stylesheet">
  <link href="/static/css/pygments.css" rel="stylesheet">

  <!-- Scripts -->
  <script src="/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/search/js/bootstrap3-typeahead.min.js"></script>

  <!-- cb-search -->
  <script src="/search/js/cb-search.js"></script>
  <script>
    $(function(){
        $("pre").css('display','block');
    });
  </script>
  <!-- Mainly scripts -->
  <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="/bower_components/metisMenu/dist/metisMenu.min.js"></script>
  <script src="/bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>

  <!-- Peity -->
  <script src="/bower_components/peity/jquery.peity.min.js"></script>

  <script src="/bower_components/PACE/pace.min.js"></script>
  <script src="/bower_components/wow/dist/wow.min.js"></script>
  <!-- Custom and plugin javascript -->
  <script src="/static/js/inspinia.js"></script>

  <!-- Rickshaw -->
  <script src="/bower_components/rickshaw/vendor/d3.v3.js"></script>
  <script src="/bower_components/rickshaw/rickshaw.min.js"></script>


  <!-- jPages -->
  <script src="/static/js/jPages.js"></script>
  <script src="/static/js/js.js"></script>
  <script type="text/javascript">
        $(function(){
          /* initiate the plugin */
          $("div.pag-holder").jPages({
              containerID  : "pag-itemContainer",
              perPage      : 10,  /* num of items per page */
              startPage    : 1,
              startRange   : 1,
              midRange     : 3,
              endRange     : 1
          });

          $("div.pag-jump button").click(function(){
            var page = parseInt($("div.pag-jump input").val());
            $("div.pag-holder").jPages(page);
          });

          $("div.pag-jump input").on("keypress", function(){
            var e=e||window.event;
            if (e.keyCode == 13) {
                var page = parseInt($("div.pag-jump input").val());
                $("div.pag-holder").jPages(page);
            } 
          });
      });
  </script>

<!-- GrowingIO -->

  <script>
    var _vds = _vds || [];
    window._vds = _vds;
    (function(){
      _vds.push(['setAccountId', 'a49d4901c7853da9']);
      (function() {
        var vds = document.createElement('script');
        vds.type='text/javascript';
        vds.async = true;
        vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(vds, s);
      })();
    })();
  </script>


</head>

	


<body id="page-top" class="landing-page">

	
	    

<!--修复手机端横轴方向左右滑动BUG-->
<style type="text/css">
    .landing-page .row {
        margin-left: 0px;
        margin-right: 0px;
    }
</style>

<div class="search-tool"
      style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
    <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog">

    <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;">
        <img src="/search/img/cb-close.png" id="close-btn"/>
    </div>
</div>

<div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;">
    <img src="/search/img/cb-search.png"  id="search-btn"  title="Double click Ctrl"/>
</div>

<div class="navbar-wrapper">
        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header page-scroll">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">KinglyJn</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a class="page-scroll" href="/blog/"></a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/blog/">Blog</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/linux/">Linux</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/cloud/">Cloud</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/java/">Java</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/c/">C</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/php/">PHP</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/db/">DB</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/htmlx/">HTMLX</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/life/">Life</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/art/">Art</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/other/">Other</a></li>
                        
                    </ul>
                </div>
            </div>
        </nav>
</div>
<div id="inSlider" class="carousel carousel-fade" data-ride="carousel">
    <div style="position:absolute;float:left;left:25%;z-index:15;width:50%;margin-bottom:18%;bottom:0;text-align:center;list-style:none;">
        <span style="color:white;font-size:24px;">以平实之心写作</span><br>
        <span style="color:white;font-size:13px;">writing with simple heart ♬. </span>
    </div>
    <!--
    <ol class="carousel-indicators">
        <li data-target="#inSlider" data-slide-to="0" class="active"></li>
        <li data-target="#inSlider" data-slide-to="1"></li>
    </ol>
    -->
    <div class="carousel-inner" role="listbox">
        <div class="item active">
            <div class="container">
                <div class="carousel-caption">
                </div>
                <div class="carousel-image wow zoomIn">
                    <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> -->
                </div>
            </div>
            <!-- Set background for slide in css -->
            <div class="header-back blog-one"></div>
        </div>
        <!--
        <div class="item">
            <div class="container">
                <div class="carousel-caption blank">
                </div>
            </div>
            Set background for slide in css
            <div class="header-back two"></div>
        </div>
        -->
    </div>
    <!--
    <a class="left carousel-control" href="#inSlider" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
    </a>
    <a class="right carousel-control" href="#inSlider" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
    </a>
    -->
</div>


	

    <div class="wrapper wrapper-content  animated fadeInRight article">
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="ibox">
                <div class="ibox-content">
                    <div class="pull-right">
                    	
                        	<button class="btn btn-white btn-xs" type="button">Java</button>
                        
                    </div>
                    <div class="text-center article-title" style="margin-bottom:50px;">
                        <h1>
                            并发编程之连接池的设计
                        </h1>
                        <a href="http://www.keyllo.com/studio/">
                            <span class="text-muted"><i class="fa fa-user"></i> KinglyJn</span>
                        </a>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <span class="text-muted"><i class="fa fa-clock-o"></i> 2017-07-28</span>
                    </div>
                    	<h3 id="一个简单的数据库连接池示例">一个简单的数据库连接池示例</h3>

<p>我们使用等待超时模式构造一个简单的数据库连接池，在示例中模拟从连接池中获取、使用、和释放连接的过程，而客户端获取连接的过程被设定为等待超时模式，也就是在1000ms每如果无法获取到可用连接，将会给客户端返回一个null。设定连接池的大小为10，然后调用客户端的线程数来模拟无法获取连接的场景。</p>

<p>首先看一下连接池的定义。它通过构造函数初始化连接数的最大上限，通过一个双向队列来维护连接，调用方先调用fetchConnection(long)方法来指定在多少毫秒内超时获取连接，当连接使用完成后，需要调用releaseConnection(Connection)来将连接放回到连接池中。</p>

<p>示例代码如下：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionPoolTest</span> <span class="o">{</span>
	<span class="c1">//线程池</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ConnectionPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConnectionPool</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
	<span class="c1">//保证所有的ConnectionRunner线程能够同时开始</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">CountDownLatch</span> <span class="n">startCountDownLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> 
	<span class="c1">//保证所有的ConnectionRunner线程都运行结束后才继续执行</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">CountDownLatch</span> <span class="n">endCountDownLatch</span><span class="o">;</span>
	
	<span class="cm">/**
	 * 模拟客户端获取、使用、最后释放数据库连接的过程
	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
		<span class="c1">//定义线程的数量，可以修改进行观察</span>
		<span class="kt">int</span> <span class="n">threadCount</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
		<span class="c1">//定义每个线程获取连接的次数</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
		<span class="n">AtomicInteger</span> <span class="n">got</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
		<span class="n">AtomicInteger</span> <span class="n">notGot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
		<span class="n">endCountDownLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">threadCount</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threadCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">ConnectionRunner</span><span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">got</span><span class="o">,</span> <span class="n">notGot</span><span class="o">),</span>
                       <span class="s">"ConnectionRunner"</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="n">startCountDownLatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
		
		<span class="n">endCountDownLatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"total invoke: "</span> <span class="o">+</span> <span class="o">(</span><span class="n">threadCount</span><span class="o">*</span><span class="n">count</span><span class="o">));</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"got connection: "</span> <span class="o">+</span> <span class="n">got</span><span class="o">);</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"not got connection: "</span> <span class="o">+</span> <span class="n">notGot</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConnectionRunner</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
		<span class="n">AtomicInteger</span> <span class="n">got</span><span class="o">;</span>
		<span class="n">AtomicInteger</span> <span class="n">notGot</span><span class="o">;</span>
		
		<span class="kd">public</span> <span class="nf">ConnectionRunner</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="n">AtomicInteger</span> <span class="n">got</span><span class="o">,</span> <span class="n">AtomicInteger</span> <span class="n">notGot</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">got</span> <span class="o">=</span> <span class="n">got</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">notGot</span> <span class="o">=</span> <span class="n">notGot</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">startCountDownLatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="o">}</span>
			
			<span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="c1">//从线程池获取连接，如果1000ms内无法获取到，将会返回null</span>
					<span class="c1">//分别统计获取到的次数和未获取到的次数got、notGot</span>
					<span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">fetchConnection</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="n">connection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
							<span class="n">connection</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
						<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
							<span class="n">pool</span><span class="o">.</span><span class="na">releaseConnection</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
							<span class="n">got</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
						<span class="o">}</span>
					<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
						<span class="n">notGot</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
					<span class="o">}</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
					<span class="n">count</span><span class="o">--;</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">endCountDownLatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>


<span class="kd">class</span> <span class="nc">ConnectionPool</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Connection</span><span class="o">&gt;</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
	<span class="kd">public</span> <span class="nf">ConnectionPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialSize</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">initialSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">initialSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
				<span class="n">pool</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">ConnectionDriver</span><span class="o">.</span><span class="na">createConnection</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">releaseConnection</span><span class="o">(</span><span class="n">Connection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">//连接释放后需要进行通知，这样其他消费者能够感知到连接池中已经归还了一个连接</span>
				<span class="n">pool</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
				<span class="n">pool</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="cm">/**
	 * 在mills时间内无法获取连接，将会返回null
	 */</span>
	<span class="kd">public</span> <span class="n">Connection</span> <span class="nf">fetchConnection</span><span class="o">(</span><span class="kt">long</span> <span class="n">mills</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">pool</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mills</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//超时</span>
				<span class="k">while</span> <span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">pool</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="n">pool</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="kt">long</span> <span class="n">future</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
				<span class="kt">long</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">mills</span><span class="o">;</span>
				<span class="k">while</span> <span class="o">(</span><span class="n">remaining</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pool</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">pool</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="n">remaining</span><span class="o">);</span>
					<span class="n">remaining</span> <span class="o">=</span> <span class="n">future</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="n">Connection</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">pool</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ConnectionDriver</span> <span class="o">{</span>
	<span class="c1">//由于java.sql.Connection是一个接口，最终的实现需要数据库驱动提供方来提供</span>
	<span class="c1">//考虑到这只是一个示例，我们通过动态代理构造了一个Connection对象，</span>
	<span class="c1">//该connection代理实现仅仅是在commit方法调用休眠100ms</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Connection</span> <span class="nf">createConnection</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="n">Connection</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>
          <span class="n">ConnectionDriver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> 
                                                   <span class="k">new</span> <span class="nf">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> 
              <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"commit"</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>上述代码使用了CountDownLatch来确保ConnectionRunner线程能够同时开始执行，并且在全部结束之后，才能使main线程从等待状态中返回。实验结果表明，在资源一定的情况下（连接池中的10个连接），随着客户端线程的逐步增加，客户端出现超时无法获取的比率不断升高。虽然客户端线程在这种超时获取的模式下无法正常获取连接，但它能够保证客户端线程不会一致挂在连接获取的操作上，而是“按时”返回，并告知客户端连接获取出现问题，是系统的一种自我保护机制。数据库连接池的设计也可以复用到其他资源的获取场景，针对昂贵的资源的获取均应该加以超时限制。<br /></p>

<h3 id="连接池技术及其示例">连接池技术及其示例</h3>

<p>对于服务端的程序，经常面对的是客户端传入的短小（执行时间短、工作内容较为单一）任务，需要服务器快速处理并返回结果。如果服务端每接收到一次任务，就创建一个线程，然后去执行，这在源性阶段是个不错的选择，但是面对成千上万的任务递交进服务器时，如果还是采用一个任务一个线程的方式，那么将会创建数以万计的线程，这不是一个好的选择。因为这会使得操作系统频繁的进行线程的上下文切换，无故增加系统的负载，而线程的创建和消亡都是需要耗费系统资源的，这无疑浪费了系统资源。</p>

<p>线程池技术很好的解决了这个问题（以空间换时间的典型事例）。它预先创建了若干数量的线程，并且不能由用户直接对线程的创建进行控制，在这个前提下重复使用固定或较为固定的线程来完成任务的执行。这样做的好处是：</p>

<ul>
  <li>消除频繁创建和消亡线程的系统资源开销</li>
  <li>面对过量任务的提交能够平缓的劣化</li>
</ul>

<p>下面先看一个简单的线程池接口定义：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * 客户端可以通过execute方法将job提交到线程池执行，而客户端自身不用等待job的执行完成
 * 这里的工作者线程代表着一个重复执行job的线程，而每个由客户端提交的job都将进入到一个工
 * 作者队列中，等待工作者线程的处理
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ThreadPool</span><span class="o">&lt;</span><span class="n">Job</span> <span class="kd">extends</span> <span class="n">Runnable</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="c1">// 执行一个job，这个job需要实现Runnbale</span>
	<span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Job</span> <span class="n">job</span><span class="o">);</span>
	
	<span class="c1">//关闭线程池</span>
	<span class="kt">void</span> <span class="nf">shutdown</span><span class="o">();</span>
	
	<span class="c1">//增加工作者线程</span>
	<span class="kt">void</span> <span class="nf">addWorkers</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">);</span>
	
	<span class="c1">//减少工作线程</span>
	<span class="kt">void</span> <span class="nf">removeWorkers</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">);</span>
	
	<span class="c1">//得到正在等待执行的任务总量</span>
	<span class="kt">int</span> <span class="nf">getJobSize</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>
</div>

<p>接下来是线程池接口的默认实现：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultThreadPool</span><span class="o">&lt;</span><span class="n">Job</span> <span class="kd">extends</span> <span class="n">Runnable</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">ThreadPool</span><span class="o">&lt;</span><span class="n">Job</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="c1">//线程池最大限制数</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_WORKER_NUMBERS</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
	<span class="c1">//线程池默认的数量</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_WORKER_NUMBERS</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
	<span class="c1">//线程池最小的数量</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MIN_WORKER_NUMBERS</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
	<span class="c1">//这是一个工作列表，将会向里面插入工作</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Job</span><span class="o">&gt;</span> <span class="n">jobs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
	<span class="c1">//工作者列表</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;());</span>
	<span class="c1">//工作者线程的数量</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">workerNum</span> <span class="o">=</span> <span class="n">DEFAULT_WORKER_NUMBERS</span><span class="o">;</span>
	<span class="c1">//线程编号生成器</span>
	<span class="kd">private</span> <span class="n">AtomicLong</span> <span class="n">threadNum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">();</span>
	
	<span class="kd">public</span> <span class="nf">DefaultThreadPool</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">initializeWorkers</span><span class="o">(</span><span class="n">DEFAULT_WORKER_NUMBERS</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nf">DefaultThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">workerNum</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">MAX_WORKER_NUMBERS</span> <span class="o">?</span> 
          		<span class="n">MAX_WORKER_NUMBERS</span> <span class="o">:</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="n">MIN_WORKER_NUMBERS</span> <span class="o">?</span> 
                  <span class="n">MIN_WORKER_NUMBERS</span> <span class="o">:</span> <span class="n">num</span><span class="o">;</span>
		<span class="n">initializeWorkers</span><span class="o">(</span><span class="n">workerNum</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">initializeWorkers</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">();</span>
			<span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
			<span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">worker</span><span class="o">,</span> <span class="s">"Thread-Worker-"</span> <span class="o">+</span> <span class="n">threadNum</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Job</span> <span class="n">job</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">job</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">//添加一个工作，然后进行通知</span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="n">jobs</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">jobs</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">job</span><span class="o">);</span>
				<span class="n">jobs</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Worker</span> <span class="n">worker</span> <span class="o">:</span> <span class="n">workers</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">worker</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addWorkers</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">jobs</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">//限制新增的worker数量不能超过最大值</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">num</span><span class="o">+</span><span class="k">this</span><span class="o">.</span><span class="na">workerNum</span> <span class="o">&gt;</span> <span class="n">MAX_WORKER_NUMBERS</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">num</span> <span class="o">=</span> <span class="n">MAX_WORKER_NUMBERS</span><span class="o">-</span><span class="k">this</span><span class="o">.</span><span class="na">workerNum</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">initializeWorkers</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
			<span class="k">this</span><span class="o">.</span><span class="na">workerNum</span> <span class="o">+=</span> <span class="n">num</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeWorkers</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">jobs</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">workerNum</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"beyond workerNum."</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">//按照给定的数量停止worker</span>
			<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">count</span><span class="o">&lt;</span><span class="n">num</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">worker</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">count</span><span class="o">++;</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">this</span><span class="o">.</span><span class="na">workerNum</span> <span class="o">-=</span> <span class="n">count</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getJobSize</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">jobs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
	<span class="o">}</span>
	
	
	<span class="cm">/**
	 * 工作者：负责消费任务
	 */</span>
	<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
		<span class="c1">//是否在工作</span>
		<span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Job</span> <span class="n">job</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="kd">synchronized</span> <span class="o">(</span><span class="n">jobs</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">while</span> <span class="o">(</span><span class="n">jobs</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="n">jobs</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
						<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">//感知到外部对workerThread的中断操作，返回</span>
							<span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
							<span class="k">return</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="c1">//取出一个job</span>
					<span class="n">job</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">job</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="c1">//注意是run而不是start</span>
							<span class="n">job</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> 
						<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// TODO</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">running</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>从线程池的默认实现我们可以看到，当客户端调用execute(Job)方法时，会不断向任务列表jobs中添加job，而每个工作线程会不断从jobs上取出一个job进行执行，当jobs为空时，工作者线程进入等待状态。</p>

<p>添加一个job后，对工作队列jobs调用了其notify方法，而不是notifyAll，因为能够确保有工作者线程被唤醒，这时使用notify竟会比使用notifyAll获得更小的开销（避免将等待队列中的线程全部移动到阻塞队列中）。</p>

<p><code class="highlighter-rouge">线程池的本质</code> 就是使用了一个线程安全的工作队列连接工作者线程和客户端线程。客户端线程将任务放入工作队列后边返回，而工作者线程则不断从工作队列上取出任务并执行。当工作队列为空的时候，所有的工作线程均【等待在工作队列上】，当客户端提交了一个任务之后，会通知任意一个工作线程，随着大量的任务被提交，更多的工作线程将被唤醒。</p>

<p><br /></p>

<h3 id="一个基于线程池技术的简单web服务器">一个基于线程池技术的简单web服务器</h3>

<p>目前的浏览器都支持多线程访问，比如在请求一个html页面的时候，页面中包含的图片资源、样式资源会被浏览器并发地发起访问获取，这样用户就不会遇到一直等到一个图片完全下载完才能查看文字内容的尴尬情况。</p>

<p>如果服务器是单线程的，多线程的浏览器也没有用武之地，因为服务器还是一个请求一个请求的顺序处理。因此，大部分web服务器都是支持并发访问的。常用的web服务器是tomcat、jetty，其在处理请求的过程中都使用了线程池技术。</p>

<p>下面通过上述线程池实现来构造一个简单的web服务器，这个web服务器用来处理http请求，目前只能处理简单的文本和jpg图片内容。这个服务器使用main线程不断加接收客户端socket连接，将连接以及请求提交给线程池处理，这使得web服务器能够同时处理多个客户端请求。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Closeable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.PrintWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleHttpServer</span> <span class="o">{</span>
    <span class="c1">// 处理HttpRequest的线程池</span>
    <span class="kd">static</span> <span class="n">ThreadPool</span><span class="o">&lt;</span><span class="n">HttpRequestHandler</span><span class="o">&gt;</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultThreadPool</span><span class="o">&lt;</span><span class="n">HttpRequestHandler</span><span class="o">&gt;(</span><span class="mi">11</span><span class="o">);</span>
    <span class="c1">// SimpleHttpServer的根路径</span>
    <span class="kd">static</span> <span class="n">String</span> <span class="n">basePath</span> <span class="o">=</span> <span class="s">"/Users/zhangqingli/Documents/workspace-ec/tongniu/zdemo-thread/src"</span><span class="o">;</span>
    <span class="kd">static</span> <span class="n">ServerSocket</span> <span class="n">serverSocket</span><span class="o">;</span>
    <span class="c1">// 服务器监听端口</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8080</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setPort</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">port</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">SimpleHttpServer</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setBasePath</span><span class="o">(</span><span class="n">String</span> <span class="n">basePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">basePath</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">basePath</span><span class="o">).</span><span class="na">exists</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">basePath</span><span class="o">).</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">SimpleHttpServer</span><span class="o">.</span><span class="na">basePath</span> <span class="o">=</span> <span class="n">basePath</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 启动SimpleHttpServer</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 接收一个客户端Socket，生成一个HttpRequestHandler，放入线程池中执行</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpRequestHandler</span><span class="o">(</span><span class="n">socket</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">serverSocket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HttpRequestHandler</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="n">Socket</span> <span class="n">socket</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">HttpRequestHandler</span><span class="o">(</span><span class="n">Socket</span> <span class="n">socket</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span>
                  <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
                <span class="n">String</span> <span class="n">header</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                <span class="c1">//由相对路径计算得出绝对路径</span>
                <span class="n">String</span> <span class="n">filePath</span> <span class="o">=</span> <span class="n">basePath</span> <span class="o">+</span> <span class="n">header</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">)[</span><span class="mi">1</span><span class="o">];</span>
                <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
                
                <span class="c1">//打印http请求</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">header</span><span class="o">);</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                		<span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                		<span class="k">if</span> <span class="o">(</span><span class="n">line</span><span class="o">==</span><span class="kc">null</span> <span class="o">||</span> <span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">trim</span><span class="o">()))</span> <span class="o">{</span>
                			<span class="k">break</span><span class="o">;</span>
                		<span class="o">}</span>
                <span class="o">}</span>
                
                <span class="c1">//如果请求jpg或ico资源</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">filePath</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"jpg"</span><span class="o">)</span> <span class="o">||</span> <span class="n">filePath</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"ico"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"HTTP/1.1 200 OK"</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Content-Type: image/jpeg"</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                    
                    <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
                    <span class="n">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bs</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
                    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">((</span><span class="n">len</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bs</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    		<span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bs</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">os</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span>
                      <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">filePath</span><span class="o">)));</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"HTTP/1.1 200 OK"</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Content-Type: text/html; charset=UTF-8"</span><span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                    <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"HTTP/1.1 500"</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">close</span><span class="o">(</span><span class="n">br</span><span class="o">,</span> <span class="n">in</span><span class="o">,</span> <span class="n">reader</span><span class="o">,</span> <span class="n">out</span><span class="o">,</span> <span class="n">socket</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//关闭流或socket</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="n">Closeable</span><span class="o">...</span> <span class="n">closeables</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">closeables</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Closeable</span> <span class="n">closeable</span> <span class="o">:</span> <span class="n">closeables</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">closeable</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// ignore</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * 启动服务器
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">start</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>测试页面index.html（存放在basePath目录下）：</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
	<span class="nt">&lt;head&gt;</span>
		<span class="nt">&lt;title&gt;</span>测试<span class="nt">&lt;/title&gt;</span>
	<span class="nt">&lt;/head&gt;</span>
	<span class="nt">&lt;body&gt;</span>
		<span class="nt">&lt;h1&gt;</span>第一张图片<span class="nt">&lt;/h1&gt;</span>
		<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"1.jpg"</span> <span class="na">style=</span><span class="s">"width:60%"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;h1&gt;</span>第二张图片<span class="nt">&lt;/h1&gt;</span>
		<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"2.jpg"</span> <span class="na">style=</span><span class="s">"width:60%"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;h1&gt;</span>第三张图片<span class="nt">&lt;/h1&gt;</span>
		<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"3.jpg"</span> <span class="na">style=</span><span class="s">"width:60%"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>测试步骤：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">//第一步：启动SimpleHttpServer服务端</span>
<span class="c1">//第二步：在浏览器地址栏输入 localhost:8080/index.html 即可看到服务端返回的响应</span>

<span class="c1">//服务端输出的http请求：</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="na">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="nl">localhost:</span><span class="mi">8080</span>
<span class="nl">Connection:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Cache</span><span class="o">-</span><span class="nl">Control:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Upgrade</span><span class="o">-</span><span class="n">Insecure</span><span class="o">-</span><span class="nl">Requests:</span> <span class="mi">1</span>
<span class="n">User</span><span class="o">-</span><span class="nl">Agent:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="o">(</span><span class="n">Macintosh</span><span class="o">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_12_2</span><span class="o">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="o">(</span><span class="n">KHTML</span><span class="o">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="o">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">59.0</span><span class="o">.</span><span class="mf">3071.115</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nl">Accept:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="o">,</span><span class="n">application</span><span class="o">/</span><span class="n">xhtml</span><span class="o">+</span><span class="n">xml</span><span class="o">,</span><span class="n">application</span><span class="o">/</span><span class="n">xml</span><span class="o">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="o">,</span><span class="n">image</span><span class="o">/</span><span class="n">webp</span><span class="o">,</span><span class="n">image</span><span class="o">/</span><span class="n">apng</span><span class="o">,*</span><span class="cm">/*;q=0.8
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.8
Cookie: Hm_lvt_d88c5dc8895505e7e0140c84e7e941f1=1493494970; _uab_collina=149365565849393142850533

GET /1.jpg HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Safari/537.36
Accept: image/webp,image/apng,image/*,*/</span><span class="o">*;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span>
<span class="nl">Referer:</span> <span class="nl">http:</span><span class="c1">//localhost:8080/index.html</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">Encoding:</span> <span class="n">gzip</span><span class="o">,</span> <span class="n">deflate</span><span class="o">,</span> <span class="n">br</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">Language:</span> <span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="o">,</span><span class="n">zh</span><span class="o">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span>
<span class="nl">Cookie:</span> <span class="n">Hm_lvt_d88c5dc8895505e7e0140c84e7e941f1</span><span class="o">=</span><span class="mi">1493494970</span><span class="o">;</span> <span class="n">_uab_collina</span><span class="o">=</span><span class="mi">149365565849393142850533</span>

<span class="n">GET</span> <span class="o">/</span><span class="mi">2</span><span class="o">.</span><span class="na">jpg</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="nl">localhost:</span><span class="mi">8080</span>
<span class="nl">Connection:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Cache</span><span class="o">-</span><span class="nl">Control:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">User</span><span class="o">-</span><span class="nl">Agent:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="o">(</span><span class="n">Macintosh</span><span class="o">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_12_2</span><span class="o">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="o">(</span><span class="n">KHTML</span><span class="o">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="o">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">59.0</span><span class="o">.</span><span class="mf">3071.115</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nl">Accept:</span> <span class="n">image</span><span class="o">/</span><span class="n">webp</span><span class="o">,</span><span class="n">image</span><span class="o">/</span><span class="n">apng</span><span class="o">,</span><span class="n">image</span><span class="cm">/*,*/</span><span class="o">*;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span>
<span class="nl">Referer:</span> <span class="nl">http:</span><span class="c1">//localhost:8080/index.html</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">Encoding:</span> <span class="n">gzip</span><span class="o">,</span> <span class="n">deflate</span><span class="o">,</span> <span class="n">br</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">Language:</span> <span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="o">,</span><span class="n">zh</span><span class="o">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span>
<span class="nl">Cookie:</span> <span class="n">Hm_lvt_d88c5dc8895505e7e0140c84e7e941f1</span><span class="o">=</span><span class="mi">1493494970</span><span class="o">;</span> <span class="n">_uab_collina</span><span class="o">=</span><span class="mi">149365565849393142850533</span>

<span class="n">GET</span> <span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="na">jpg</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="nl">localhost:</span><span class="mi">8080</span>
<span class="nl">Connection:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="nl">Pragma:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">Cache</span><span class="o">-</span><span class="nl">Control:</span> <span class="n">no</span><span class="o">-</span><span class="n">cache</span>
<span class="n">User</span><span class="o">-</span><span class="nl">Agent:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="o">(</span><span class="n">Macintosh</span><span class="o">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_12_2</span><span class="o">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="o">(</span><span class="n">KHTML</span><span class="o">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="o">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">59.0</span><span class="o">.</span><span class="mf">3071.115</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span>
<span class="nl">Accept:</span> <span class="n">image</span><span class="o">/</span><span class="n">webp</span><span class="o">,</span><span class="n">image</span><span class="o">/</span><span class="n">apng</span><span class="o">,</span><span class="n">image</span><span class="cm">/*,*/</span><span class="o">*;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span>
<span class="nl">Referer:</span> <span class="nl">http:</span><span class="c1">//localhost:8080/index.html</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">Encoding:</span> <span class="n">gzip</span><span class="o">,</span> <span class="n">deflate</span><span class="o">,</span> <span class="n">br</span>
<span class="n">Accept</span><span class="o">-</span><span class="nl">Language:</span> <span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="o">,</span><span class="n">zh</span><span class="o">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span>
<span class="nl">Cookie:</span> <span class="n">Hm_lvt_d88c5dc8895505e7e0140c84e7e941f1</span><span class="o">=</span><span class="mi">1493494970</span><span class="o">;</span> <span class="n">_uab_collina</span><span class="o">=</span><span class="mi">149365565849393142850533</span>


<span class="c1">//浏览器响应头</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="o">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="nl">Server:</span> <span class="n">Keyllo</span>
  
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type:</span> <span class="n">image</span><span class="o">/</span><span class="n">jpeg</span>
<span class="nl">Server:</span> <span class="n">Keyllo</span>
  
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type:</span> <span class="n">image</span><span class="o">/</span><span class="n">jpeg</span>
<span class="nl">Server:</span> <span class="n">Keyllo</span>
  
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="nl">Type:</span> <span class="n">image</span><span class="o">/</span><span class="n">jpeg</span>
<span class="nl">Server:</span> <span class="n">Keyllo</span>
</code></pre>
</div>

<p>SimpleHttpServer与客户端建立连接之后，并不会处理客户端的请求，而是将器包装成HttpRequestHandler并交由线程池处理，在线程池的Worker处理客户端请求的同时，SimpleHttpServer能继续完成后续客户端连接的建立。不会阻塞后续客户端的请求。</p>

<p>下面通过Apache HTTP server benchmarking tool （版本2.3）来测试不同线程数下，SimpleHttpServer的吞吐量的表现。</p>

<p>测试场景是5000次请求，分10个线程并发执行，测试内容主要考察响应时间（越小越好）和每秒查询的数量（越高越好）测试结果如下如所示：</p>

<pre><code class="language-default">线程池数量			1			5			10
响应时间			0.352		0.246		 0.163
每秒查询的数量		  3076		  4065		   6123
测试完成时间		   1.625	   1.230		0.816
</code></pre>

<p>可以看到，随着线程数的增加，SimpleHttpServer的吞吐量不断增大，响应时间不断变小，线程池的作用非常明显。</p>

<p>但是线程池并不是越多越好，具体的数量需要评估每个任务的处理时间，以及当前计算机处理器能力和数量。使用的线程过少，无法发挥处理器的性能；使用的线程过多，将会增加系统的无故开销，反而会起到反作用。</p>

                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                                <h5 style="display: inline;">Tags:</h5>
                                
                                    <button class="btn btn-white btn-xs" type="button">Java</button>
                                
                        </div>
                        
                        <!--
                        <div class="col-md-6">
                            <div class="small text-right">
                                <div>    
                                    <i class="fa fa-comments-o"> </i> 
                                    <span class="ds-comments">0</span>条评论
                                </div>
                                <div>
                                    <i class="fa fa-share-alt"> </i> 
                                    <span class="ds-shares">0</span>条转发
                                </div>  
                            </div>
                        </div>
                        -->
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-lg-12">
                            <!-- donate -->
                            
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal2">
    Donate
</button>
<div class="modal inmodal" id="myModal2" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Donate Me</h4>
                <small class="font-bold">Thanks for your support!</small>
            </div>
            <div class="modal-body">
                <div class="tabbable" id="tabs-960227">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#panel-405278" data-toggle="tab">Alipay</a>
                        </li>
                        <li>
                            <a href="#panel-874705" data-toggle="tab">Wechat</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="panel-405278">
                            <div class="text-center">
                                <img src="/static/img/pay/alipay.png"" height="250" width="250">
                            </div>    
                        </div>
                        <div class="tab-pane" id="panel-874705">
                            <div class="text-center">
                                <img src="/static/img/pay/wechat.png"" height="250" width="250">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

                            
                            <br>
                            <!-- share -->
                            
                                
<!--分享-->
<div class="row" style="margin-top:30px;">
	<h2>Share:</h2>
    <div class="social-share" style="margin-left:-5px;"data-sites="wechat,qq,qzone,weibo"></div> 
</div>
<link rel="stylesheet" href="/static/css/share.min.css">
<script src="/static/js/jquery.share.min.js"></script>
<script src="/static/js/embed.js"></script>

<script>
  var url = 'http://localhost:4000/java/2017/07/28/java-concurrent-05.html';
  var source = 'http://localhost:4000/java/2017/07/28/java-concurrent-05.html';
  var title = '并发编程之连接池的设计';
  var excerpt = $("p:eq(0)").text();
  
  var imageUrl = 'http://localhost:4000/static/img/landing/header_one.jpg';
  var imgEle = $(".content_img:eq(0)");
  if (imgEle) {
    imageUrl = imgEle.attr("src");
  }

  var $config = {
      url: url, // 网址，默认使用 window.location.href
      source: source, // 来源（QQ空间会用到）, 默认读取head标签：<meta name="site" content="http://overtrue" />
      title: title, // 标题，默认读取 document.title 或者 <meta name="title" content="share.js" />
      description: excerpt, // 描述, 默认读取head标签：<meta name="description" content="PHP弱类型的实现原理分析" />
      image: imageUrl, // 图片, 默认取网页中第一个img标签
      sites: ['qzone', 'qq', 'weibo','wechat','douban'], // 启用的站点
      //disabled: ['google', 'facebook', 'twitter'], // 禁用的站点
      wechatQrcodeTitle: "微信扫一扫：分享", // 微信二维码提示文字
      wechatQrcodeHelper: '<p style="font-size:10px;">微信里点“发现”，扫一下</p><p style="font-size:10px;">二维码便可将本文分享至朋友圈。</p>',
   };
  $('.social-share').share($config);
</script>




                            
                            <br>
                            <!-- comment -->
                            <!--



-->

<!-- 多说评论框 start -->
<div class="row" style="margin-top:25px;"></div>
<div class="ds-thread" data-thread-key="/java/2017/07/28/java-concurrent-05.html" data-title="并发编程之连接池的设计" data-url="http://localhost:4000/java/2017/07/28/java-concurrent-05.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
	var duoshuoQuery = {short_name:"kinglyjn"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
<!-- 多说公共JS代码 end -->



                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>



	
	    <script src="/static/js/scroll.js"></script>

<!-- Baidu analytics -->


<!-- Google analytics -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-73784599-1', 'auto');
    ga('send', 'pageview');

  </script>


<!--

-->

<!--

-->

<script async src="/static/js/count_page.js"></script>

	

</body>
</html>